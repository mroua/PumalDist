{% extends "base.html" %}
{% load mes_tags %}
{% load static %}
{% block title %}Encaissement{% endblock %}

{% block page_heading %}
    <div>
        <a href="{% url 'encaissement' %}" class="block px-4 py-2 hover:bg-gray-200 rounded
            {% if request.path == '/encaissement/' %} bg-gray-200{% endif %}"
        >Encaissements</a>
    </div>

    <div>
        <a href="{% url 'accompte' %}" class="block px-4 py-2 hover:bg-gray-200 rounded
            {% if request.name == '/encaissement/accompte' %} bg-gray-200{% endif %}"
        >Accompte</a>
    </div>

{% endblock %}
{% block content %}

    <style>
        .hidden {
            display: none;
        }

        .tom-select .option,
        .tom-select .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tom-select .left {
            flex-grow: 1;
            text-align: left;
        }

        .tom-select .right {
            flex-shrink: 0;
            text-align: right;
            margin-left: 10px;
        }
    </style>

    <!-- Add Encaissement Sidebar -->
    <div id="addSidebar" style="margin-top: -10px"
         class="fixed right-0 top-0 bottom-0 w-2/5 bg-white shadow-lg flex flex-col transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Encaissement</h3>
            <button id="closeSidebar" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto">
            <!-- Step 1: Select Products -->
            <div class="p-4 grid grid-cols-2 gap-4">
                <div class="mb-0">
                    <label for="distenc" class="block text-sm font-medium text-gray-700 mb-2">Distributeur</label>
                    <select id="distenc"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        {% for dist in listedist %}
                            <option value="{{ dist.id }}">{{ dist.designation }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-0">
                    <label for="payenc" class="block text-sm font-medium text-gray-700 mb-2">Payeur</label>
                    <select id="payenc"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        {% for pay in listepayeur %}
                            <option value="{{ pay.id }}">{{ pay.designation }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-0">
                    <label class="flex items-center">
                        <input type="checkbox" id="encaissementSubstitution" class="mr-2">
                        <span>Encaissement de substitution</span>
                    </label>
                </div>
                <div id="activateelem" class="mb-0 hidden">
                    <label class="flex items-center">
                        <input type="checkbox" id="activateSubstitut" class="mr-2">
                        <span>Activer le payeur substitué</span>
                    </label>
                </div>
                <div id="substitutionSection" class="hidden col-span-2 grid grid-cols-2 gap-4">
                    <div class="mb-0">
                        <label for="payeurSubstitue" class="block text-sm font-medium text-gray-700 mb-2">Payeur
                            substitué</label>
                        <select id="payeurSubstitue"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for pay in listepayeur %}
                                <option value="{{ pay.id }}">{{ pay.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="creance_subfacpayeur"
                               class="block mb-1 text-sm font-medium text-gray-900 dark:text-gray-400">Facture
                            substituée</label>
                        <select id="creance_subfacpayeur" multiple name="Facture[]" placeholder="Factures..."
                                class="tom-select border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500
                                block w-full p-1">
                            {% for fac in listefacture %}
                                <option value="{{ fac.id }}" data-code="{{ fac.code }}"
                                        data-montant="{{ fac.restant|floatformat }}">
                                    {{ fac.code }} ({{ fac.restant|floatformat }} DA)
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                </div>

            </div>

            <div class="p-4 grid grid-cols-2 gap-4">
                <div class="">
                    <label for="accountsomme" class="block text-sm font-medium text-gray-700 mb-1">Accompte</label>
                    <label id="accountsomme" data-value="0" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg
                    block w-full p-2.5 text-right">0 DA
                    </label>
                </div>
                <div class="">
                    <label for="montantenc"
                           class="block mb-1 pl-1 text-sm font-medium text-gray-900">Montant</label>
                    <label for="montantenc" id="display_enc"
                           class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 text-right">0
                        DA</label>
                    <input id="montantenc" value="0" type="number" class="w-0 h-0">
                </div>
                <div class="mb-0 flex">
                    <p class="text-gray-900 text-sm rounded-lg w-full">Réstant accompte</p>
                    <p id="restant_accompte" class="text-gray-900 text-sm rounded-lg w-full text-right pr-2">0 DA</p>
                </div>
                <div class="mb-0 flex">
                    <p class="text-gray-900 text-sm rounded-lg w-full">Réstant montant</p>
                    <p id="restant_montant" class="text-gray-900 text-sm rounded-lg w-full text-right pr-2">0 DA</p>
                </div>
                <div class="mb-0 col-span-2 grid grid-cols-3 gap-2">
                    <label for="hs-radio-on-right"
                           class="flex p-3 w-full bg-white border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400">
                        <span class="text-sm text-gray-500 dark:text-neutral-400">Cheque</span>
                        <input type="radio" name="options" value="Cheque" checked id="hs-radio-on-right">
                    </label>

                    <label for="hs-radio-on-right-checked1"
                           class="flex p-3 w-full bg-white border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400">
                        <span class="text-sm text-gray-500 dark:text-neutral-400">Virement</span>
                        <input type="radio" name="options" value="Virement" id="hs-radio-on-right-checked1">
                    </label>

                    <label for="hs-radio-on-right-checked2"
                           class="flex p-3 w-full bg-white border border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400">
                        <span class="text-sm text-gray-500 dark:text-neutral-400">Espece</span>
                        <input type="radio" name="options" value="Espece" id="hs-radio-on-right-checked2">
                    </label>
                </div>

                <div class="mb-0">
                    <label for="banqueenc" class="block text-sm font-medium text-gray-700 mb-1">Banque</label>
                    <select id="banqueenc"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        {% for bnq in listebanque %}
                            {{ bnq }}
                            <option value="{{ bnq.id }}">{{ bnq.designation }} ({{ bnq.code }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-0">
                    <label for="numeroenc"
                           class="block mb-1 pl-1 text-sm font-medium text-gray-900">Numéro</label>
                    <input id="numeroenc"
                           class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 text-right"/>
                </div>

                <div class="mb-0">
                    <label for="datedepot"
                           class="block mb-1 pl-1 text-sm font-medium text-gray-900">Date dépot</label>
                    <input type="date" id="datedepot"
                           class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="mb-0">
                    <label for="datevalisation"
                           class="block mb-1 pl-1 text-sm font-medium text-gray-900">Date valisation de la
                        banque</label>
                    <input type="date" id="datevalisation"
                           class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="mb-0 cols-span-2">

                </div>
            </div>

            <div class="px-4 ">
                <div class="grid grid-cols-4 col-span-2 block rounded-t-lg border shadow-xs text-white p-3 bg-blue-800">
                    <div class="capitalize text-xs font-bold py-2 px-2">N° Factures</div>
                    <div class="capitalize text-xs font-bold py-2 px-2 text-right">Montant</div>
                    <div class="capitalize text-xs font-bold py-2 px-2 text-right">Restant</div>
                    <div class="capitalize text-xs font-bold py-2 px-2 text-center">Date d'écheance</div>
                </div>
                <div class="listefacture p-1 overflow-y-auto col-span-2" id="listefacture"></div>
            </div>

        </div>
        <div class="p-4 flex justify-between">
            <button class="closePopup bg-gray-500 text-white p-2 rounded">Annuler</button>
            <button id="addenc" class="bg-green-300 text-white p-2 rounded">Ajouter</button>
        </div>


    </div>

    <!-- Edit Sidebar -->
    <div id="editSidebar" style="margin-top: -10px"
         class="fixed right-0 top-0 bottom-0 w-4/5 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Modifier la commande</h3>
            <button id="closeEditSidebar" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>

        <!-- Step 1: Select Products -->
        <div id="editStep1" class="p-4 h-full">
            <div class="p-4 h-28 flex justify-around border border-gray-300 rounded-lg mb-4 gap-4">
                <!-- Type Filter -->
                <div class="mb-4 w-64">
                    <label for="editTypeFilter" class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <select id="editTypeFilter"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="">Tous</option>
                        {% for fil in liste_type %}
                            <option id="{{ fil.id }}">{{ fil.designation }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Measure Filter -->
                <div class="mb-4 w-64">
                    <label for="editMeasureFilter" class="block text-sm font-medium text-gray-700 mb-2">Mesure</label>
                    <select id="editMeasureFilter"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="">Tous</option>
                        {% for fil in liste_mesure %}
                            <option id="{{ fil.id }}">{{ fil.designation }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Field Filter -->
                <div class="mb-4 w-64">
                    <label for="editColorfilter" class="block text-sm font-medium text-gray-700 mb-2">Couleur</label>
                    <select id="editColorfilter"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <option value="">Tous</option>
                        {% for fil in liste_couleur %}
                            <option id="{{ fil.id }}">{{ fil.designation }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Field Filter -->
                <div class="mb-4 w-64">
                    <label for="editDistfield" class="block text-sm font-medium text-gray-700 mb-2">Selectionner le
                        distributeur</label>
                    <select id="editDistfield"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        {% for fil in liste_distributeur %}
                            <option data-designation="{{ fil.designation }}" data-username="{{ fil.user.nom }}"
                                    data-email="{{ fil.user.email }}"
                                    id="{{ fil.id }}" value="{{ fil.id }}">{{ fil.designation }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="h-4/6 overflow-y-auto">
                <div id="editProductList" class="grid gap-4 w-full"></div>
            </div>

            <button id="goToEditStep2" class="goToEditStep2 h-10 mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">
                Suivant
            </button>
        </div>

        <!-- Step 2: Review Selected Products -->
        <div id="editStep2" class="p-4 hidden">
            <h3 class="text-lg font-semibold mb-4">Modifier les produits sélectionnés</h3>
            <div class="h-4/6 overflow-y-auto">
                <div id="editSelectedProducts"></div>
            </div>

            <div class="flex justify-end pr-28">
                <div class="h-16">Total:</div>
                <div class="h-16 w-1/6 text-right pr-8" id="editTotalPrice">0 DA</div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button id="goToEditStep1" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                <button id="goToEditStep3" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Suivant</button>
            </div>
        </div>

        <!-- Step 3: Confirm Order -->
        <div id="editStep3" class="p-4 hidden">
            <!-- Logo Section -->
            <div class="h-4/5 w-full flex flex-col  items-center">

                <div class="w-2/3">
                    <div class="flex justify-center mb-4">
                        <img src="{% static 'images/puma.svg' %}" alt="Company Logo" class="h-16">
                    </div>

                    <!-- Facture Details -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- Recipient Details -->
                        <div class="">
                            <p id="editRecipientCompany">Nom de l'entreprise</p>
                            <p id="editRecipientName">Nom et prénom</p>
                            <p id="editRecipientEmail">email@domaine.com</p>
                        </div>

                        <!-- Facture Info -->
                        <div class="text-right">
                            <!--<p id="editFactureCode">12345</p>-->
                            <p id="editFactureDate">01/01/2024</p>
                            <p id="editIssuerName">{{ request.user.nom }}</p>
                        </div>
                    </div>

                    <!-- Product Details Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-t border-b border-gray-300">
                            <thead>
                            <tr>
                                <th class="p-2 text-left">Désignation & Référence</th>
                                <th class="p-2 text-center">Prix Unitaire</th>
                                <th class="p-2 text-center">Quantité</th>
                                <th class="p-2 text-center">Total</th>
                            </tr>
                            </thead>
                            <tbody id="editProductDetails">
                            <!-- Product rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Total Section -->
                    <div class="flex justify-end">
                        <div class="mt-4 w-1/3">
                            <div class="flex justify-between mt-2 font-semibold">
                                <span>Total:</span>
                                <span id="editTotalAmount" class="pr-2">0 DA</span>
                            </div>
                            <div class="flex justify-between mt-2 font-semibold">
                                <span>TVA:</span>
                                <span id="editTaxAmount" class="pr-2">0 DA</span>
                            </div>
                            <div class="flex justify-between mt-2 font-semibold">
                                <span>Montant Total:</span>
                                <span id="editAmountDue" class="pr-2">0 DA</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex justify-between items-center mt-4">
                <button class="goToEditStep2 bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                <button id="confirmEditOrder" class="bg-green-500 text-white px-4 py-2 rounded-lg">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- View Sidebar -->
    <div id="viewSidebar" style="margin-top: -10px"
         class="flex flex-col fixed right-0 top-0 bottom-0 w-4/5 bg-white shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Détail Commande</h3>
            <button id="closeViewSidebar" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>

        <div id="containerdatacmd" class="flex-grow flex flex-col p-8">

        </div>


    </div>

    <div class="w-full h-full flex flex-col py-2 overflow-y-auto text-bold">


        <div class="flex justify-between items-center mb-4" style="margin-top: -8px">
            <h2 class="text-2xl font-bold text-gray-700">Liste des Encaissement</h2>
            <div>
                <button id="filterButton" class="bg-gray-800 text-white py-2 px-4 rounded-lg hover:bg-gray-700">Filtrer
                </button>

                <button id="addButton" class="addButton bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-400">
                    Encaissement
                </button>
                <button id="popupButton" class="popupButton bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-400">
                    facture
                </button>
            </div>

        </div>

        <div class="px-2">
            <div class="flex text-gray-800 text-xs font-bold">
                <div class="capitalize" style="width: 70px"></div>
                <div class="p-2 flex-grow grid grid-cols-6 gap-4">
                    <div class="capitalize text-right">
                        <div><span>Totals </span><span class="ml-3"> HT</span></div>
                        <div><span>Totals</span><span class="ml-1"> TTC</span></div>


                    </div>
                    <div class="capitalize text-right">
                        <p>{{ somme_total|floate_redefined }} DA</p>
                        <p>{{ somme_total|taxednumber }} DA</p>
                    </div>
                    <div class="capitalize px-4 text-right">
                        <p>{{ somme_circu|floate_redefined }} DA</p>
                        <p></p>
                    </div>
                    <div class="capitalize px-4 text-right">
                        <p>{{ somme_depot|floate_redefined }} DA</p>
                        <p></p>
                    </div>
                    <div class="capitalize text-right pr-2">
                        <p>{{ somme_encai|floate_redefined }} DA</p>
                        <p></p>
                    </div>
                </div>
                <div class="capitalize text-center" style="width: 70px"></div>
            </div>
        </div>
        <div class="bg-white shadow-md rounded-t-lg p-2 mb-4">
            <div class="flex text-gray-600 font-semibold">
                <div class="capitalize" style="width: 70px">Code</div>
                <div class="flex-grow grid grid-cols-6 gap-4">
                    <div class="capitalize">Distributeur</div>
                    <!--<div class="capitalize text-center">Plafonnement</div>-->
                    <div class="capitalize pr-4 text-right">Vente</div>
                    <div class="capitalize pr-4 text-right">Circulation</div>
                    <div class="capitalize pr-4 text-right">Depot</div>
                    <div class="capitalize pr-4 text-right">Encaissement</div>
                    <div class="capitalize pr-4 text-right">échue</div>
                </div>
                <div class="capitalize text-center" style="width: 80px">Actions</div>
            </div>
        </div>
        <div class="flex-grow space-y-4 overflow-y-auto">
            {% for elem in lise_fact %}
                <div class="bg-white shadow-md rounded-lg p-2">
                    <div class="flex text-gray-600 font-semibold">
                        <div class="capitalize text-xs" style="width: 70px">{{ elem.code }}</div>
                        <div class="flex-grow grid grid-cols-6 gap-2">
                            <div class="capitalize">
                                <p class="text-xs text-gray-500 truncate">{{ elem.distributeur }}</p>
                                <p class="text-xs text-gray-500 truncate">{{ elem.payeur }}</p>
                            </div>
                            <!--<div class="capitalize">
                                <div class="text-xs font-bold text-gray-800 text-right">{ { elem.plafonnement|floate_redefined }}
                                    DA
                                </div>
                            </div>-->
                            <div class="capitalize">
                                <div class="flex w-full justify-between ">
                                    <div class="text-xs font-bold text-gray-500">HT:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">
                                        {{ elem.total|floate_redefined }}
                                        DA
                                    </div>
                                </div>
                                <div class="flex w-full justify-between ">
                                    <div class="text-xs font-bold text-gray-500">TTC:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">
                                        {{ elem.total|taxednumber }}
                                        DA
                                    </div>
                                </div>
                            </div>
                            <div class="capitalize">
                                <div class="flex w-full justify-between ">
                                    <div class="text-xs text-gray-500">HT:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_validation_depot_false|floate_redefined }}
                                        DA
                                    </div>
                                </div>
                                <div class="flex w-full justify-between ">
                                    <div class="text-xs text-gray-500">TTC:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_validation_depot_false|taxednumber }}
                                        DA
                                    </div>
                                </div>
                            </div>
                            <div class="capitalize">
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">HT:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_validation_depot_true|floate_redefined }}
                                        DA
                                    </div>
                                </div>
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">TTC:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_validation_depot_true|taxednumber }}
                                        DA
                                    </div>
                                </div>
                            </div>
                            <div class="capitalize text-center">
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">HT:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_encaissement|floate_redefined }}
                                        DA
                                    </div>
                                </div>
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">TTC:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.total_encaissement|taxednumber }}
                                        DA
                                    </div>
                                </div>
                            </div>
                            <div class="capitalize text-center">
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">HT:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.montant_echue|floate_redefined }}
                                        DA
                                    </div>
                                </div>
                                <div class="flex w-full justify-between">
                                    <div class="text-xs text-gray-500">TTC:</div>
                                    <div class="text-xs font-bold text-gray-800 text-right">{{ elem.montant_echue|taxednumber }}
                                        DA
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="capitalize text-center pl-3" style="width: 100px">
                            <button class="bg-blue-500 text-white p-2 rounded">
                                <i id="editButton" class="editButton fas fa-pencil-alt" onclick=""></i>
                            </button>
                            <button class="bg-red-500 text-white p-2 rounded"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>


    </div>

    <!-- Filter Modal -->
    <div id="addbl" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
        <form id="formaddfacture">
            <div class="relative w-screen h-screen flex justify-center items-center">
                <div class="bg-white w-96 h-3/4 p-6 rounded-lg shadow-lg gap-y-2 flex flex-col">
                    <div class="w-full flex justify-between">
                        <div><h3 class="text-lg font-semibold">Ajout Facture</h3></div>
                        <div>
                            <button class="closePopup text-gray-700 p-2">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex-grow grid grid-cols-1 overflow-y-auto mb-4">
                        <div class="mb-3">
                            <label for="distributeur" class="block mb-1 pl-1 text-sm font-medium text-gray-900">Distribupteur</label>
                            <select id="distributeur" class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500
                                    block w-full p-2.5">
                                {% for elem in listedist %}
                                    <option class="p-2.5" value="{{ elem.id }}">{{ elem.designation }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="payeur" class="block mb-1 pl-1 text-sm font-medium text-gray-900">Payeur</label>
                            <select id="payeur" class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500
                                    block w-full p-2.5">
                                {% for elem in listepayeur %}
                                    <option class="p-2.5" value="{{ elem.id }}">{{ elem.designation }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="code" class="block mb-1 pl-1 text-sm font-medium text-gray-900">Code</label>
                            <input type="text" id="code" name="code" placeholder="AZER01"
                                   class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div class="mb-3">
                            <label for="date_facture" class="block mb-1 pl-1 text-sm font-medium text-gray-900">Date
                                échéance</label>
                            <input type="date" id="date_facture"
                                   class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div class="mb-3">
                            <label for="facture_montant"
                                   class="block mb-1 pl-1 text-sm font-medium text-gray-900">Montant</label>
                            <label for="facture_montant" id="display_montant"
                                   class="border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 text-right">0
                                DA</label>
                            <input id="facture_montant" value="" type="number" class="w-0 h-0">
                        </div>
                        <div class="flex items-center space-x-4 border border-gray-300 rounded-lg h-11">
                            <label for="fc_facture" class="block flex-shrink-0">
                                <div class="flex items-center justify-center px-4 h-full rounded-l-lg
                                        bg-white text-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white
                                        transition-colors duration-300">
                                    <span class="">Fichier FC</span>
                                </div>
                                <input id="fc_facture" type="file" class="hidden"/>
                            </label>
                            <span id="file-name" class="text-gray-500 w-64 truncate">No fc file</span>
                        </div>

                        <div>

                        </div>
                    </div>

                    <div class="flex justify-between">
                        <button class="closePopup bg-gray-500 text-white p-2 rounded">Annuler</button>
                        <button type="submit" class="bg-green-300 text-white p-2 rounded">Ajouter</button>
                    </div>

                </div>
            </div>
        </form>

    </div>


    <script>


        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);
        }

        function parseFormattedNumber(formattedNum) {
            // Replace spaces and commas, then parse the string as a float
            return parseFloat(formattedNum.replace(/\s/g, '').replace(',', '.'));
        }


        new TomSelect('#creance_subfacpayeur', {
            render: {
                option: function (data, escape) {
                    return '<div class="option">' +
                        '<span class="left">' + escape(data.code) + '</span>' +
                        '<span class="right">' + escape(formatNumber(data.montant)) + ' DA</span>' +
                        '</div>';
                },
                item: function (data, escape) {
                    return '<div class="item">' +
                        '<span class="left">' + escape(data.code) + '</span>' +
                        '<span class="right">' + escape(formatNumber(data.montant)) + ' DA</span>' +
                        '</div>';
                }
            }
        });


        $distributeur = $("#distributeur");
        $payeur = $("#payeur");
        $code = $("#code");
        $date_facture = $("#date_facture");


        // Toggle the sidebar
        $('#addButton').on('click', function () {
            $('#addSidebar').toggleClass('translate-x-full');
        });

        // Close the sidebar
        $('#closeSidebar').on('click', function () {
            $('#addSidebar').addClass('translate-x-full');
        });


        $(document).ready(function () {
            // Show the popup
            $('.popupButton').click(function () {
                $('#addbl').fadeIn();
            });

            // Close the popup
            $('.closePopup').click(function () {
                $('#addbl').fadeOut();
            });

            // Optional: Close popup if clicking outside of the popup content
            $(window).click(function (event) {
                if ($(event.target).is('#addbl')) {
                    $('#addbl').fadeOut();
                }
            });
        });


        $('#fc_facture').on('change', function () {
            const fileName = $(this).val().split('\\').pop() || 'No fc file';
            $('#file-name').text(fileName);
        });


        $display_montant = $('#display_montant');
        $facture_montant = $('#facture_montant');

        $display_montant.on('click', function () {
            $facture_montant.trigger('click')
        });


        $facture_montant.on('keyup', function () {

            if ($facture_montant.val().length === 0) $display_montant.html('0 DA');
            else $display_montant.html(parseFloat($facture_montant.val()).toLocaleString('en-US').replaceAll(',', ' ') + ' DA');
        });

        $facture_montant.focus(function () {
            if ($display_montant.hasClass('border-blue-500')) {
            } else $display_montant.addClass('border-blue-500');
        });


        $facture_montant.focusout(function () {
            $display_montant.removeClass('border-blue-500')
        });


        $('#formaddfacture').on('submit', function (e) {
            e.preventDefault(); // Prevent the default form submission

            var form = new FormData();

            // Add basic form data
            form.append("payeur", $payeur.val());
            form.append("code", $code.val());
            form.append("montant", $facture_montant.val());
            form.append("date_facture", $date_facture.val());

            // Add the photo
            var photoFile = $('#fc_facture')[0].files[0];
            if (photoFile) {
                form.append("fc_file", photoFile);
            }


            var settings = {
                "url": "/api/facture/",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "X-CSRFToken": $('input[name= csrfmiddlewaretoken]').val(),  // Assuming you have CSRF token in your template context
                },
                "processData": false,
                "contentType": false,
                "data": form
            };

            $.ajax(settings)
                .done(function (response) {

                    window.location.href = "/encaissement/";
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Log the entire jqXHR object to see all details
                    console.log('jqXHR:', jqXHR);

                    // Log the status text
                    console.log('Status:', textStatus);

                    // Log the error thrown
                    console.log('Error Thrown:', errorThrown);

                    // Log the response text, which might contain detailed error messages
                    console.log('Response Text:', jqXHR.responseText);

                    // Optionally, parse the responseText as JSON if it's in JSON format
                    try {
                        var responseJSON = JSON.parse(jqXHR.responseText);
                        console.log('Response JSON:', responseJSON);
                    } catch (e) {
                        console.error('Failed to parse response as JSON:', e);
                    }

                });
        });


        $(document).ready(function () {
            // Show or hide the substitution section based on the encaissement checkbox
            $('#encaissementSubstitution').change(function () {
                if ($(this).is(':checked')) {
                    $('#substitutionSection').removeClass('hidden');
                    $('#activateelem').removeClass('hidden');
                } else {
                    $('#substitutionSection').addClass('hidden');
                    $('#activateelem').addClass('hidden');
                    $('#activatePayeurSubstitution').prop('checked', false);
                    $('#activateSubstitut').prop('checked', false);
                    $('#payeurSubstitue').empty();  // Clear payeur options
                    $('#factureSubstitue').empty(); // Clear facture options
                    $('#selectedFactures').empty(); // Clear selected factures display
                }
            });

            // Handle changes in the facture substitué select box
            $('#factureSubstitue').change(function () {
                const selectedFactures = $(this).val();
                $('#selectedFactures').empty(); // Clear the current list
                if (selectedFactures) {
                    selectedFactures.forEach(facture => {
                        $('#selectedFactures').append(`<p>${facture}</p>`);
                    });
                }
            });
        });
        let selectedFactures = [];

        $(document).ready(function () {
            $display_enc = $('#display_enc');
            $montantenc = $('#montantenc');

            $display_enc.on('click', function () {
                $montantenc.trigger('click')
            });


            $montantenc.on('keyup', function () {
                if ($montantenc.val().length === 0) $display_enc.html('0.00 DA');
                else {
                    $display_enc.html(formatNumber($montantenc.val()) + ' DA');
                }
                checksomme();
            });

            $montantenc.focus(function () {
                if ($display_enc.hasClass('border-blue-500')) {
                } else $display_enc.addClass('border-blue-500');
            });


            $montantenc.focusout(function () {
                $display_enc.removeClass('border-blue-500')
            });


            $('#distributeur').change(function () {
                var distributeurId = $(this).val();

                $.ajax({
                    url: '/api/payeur?distributeur=' + distributeurId, // Update this with your actual API endpoint
                    method: 'GET',
                    data: {
                        distributeur: distributeurId
                    },
                    success: function (response) {
                        // Assuming 'response' contains the list of payeurs in JSON format
                        var payeurSelect = $('#payeur');
                        payeurSelect.empty(); // Clear the current options

                        $.each(response, function (index, payeur) {
                            payeurSelect.append(new Option(payeur.designation, payeur.id));
                        });
                    },
                    error: function (error) {
                        console.log("Error fetching payeur data:", error);
                    }
                });
            });


        });

        $(document).ready(function () {

            $('#distenc').change(function () {
                var distributeurId = $(this).val();

                $.ajax({
                    url: '/api/payeur?distributeur=' + distributeurId, // Update this with your actual API endpoint
                    method: 'GET',
                    data: {
                        distributeur: distributeurId
                    },
                    success: function (response) {
                        // Assuming 'response' contains the list of payeurs in JSON format

                        var payeurSelect = $('#payenc');
                        payeurSelect.empty();

                        $.each(response, function (index, payeur) {
                            payeurSelect.append(new Option(payeur.designation, payeur.id));
                        });

                        var payeurSub = $('#payeurSubstitue');
                        payeurSub.empty();

                        $.each(response, function (index, payeur) {
                            payeurSub.append(new Option(payeur.designation, payeur.id));
                        });
                        loadFactures($('#payenc').val());
                        ChargeAccount($('#payenc').val())
                    },
                    error: function (error) {
                        console.log("Error fetching payeur data:", error);
                    }
                });
            });


            // Handle change event for payenc select (second instance)
            $('#payenc').change(function () {
                var payeurId = $(this).val();

                ChargeAccount(payeurId)

            });

            function appendFactures(factures) {
                $('#listefacture').empty(); // Clear existing content
                factures.forEach(function (facture) {
                    var factureHtml = `
                <div class="grid grid-cols-4 col-span-2 border-t">
                    <div class="py-2 px-2">
                        <input type="checkbox" id="checkbox_${facture.id}" class="mr-2 facturecheckebox" onchange="handleCheckboxChange(this)">
                        ${facture.code}
                    </div>
                    <div class="py-2 px-2 text-right" data-value="${facture.montant}" id="montant_${facture.id}">${formatNumber(facture.montant)} DA</div>
                    <div class="py-2 px-2 text-right" id="restant_${facture.id}">0.00 DA</div>
                    <div class="py-2 px-2 text-center">${facture.date_echeance}</div>
                </div>
            `;
                    $('#listefacture').append(factureHtml);
                    selectedFactures = [];

                });
            }

            function loadFactures(payeurId) {
                $.ajax({
                    url: `/encaissement/get-factures/${payeurId}/`,
                    method: 'GET',
                    success: function (data) {
                        appendFactures(data.factures);
                    },
                    error: function () {
                        console.error('Failed to load factures.');
                    }
                });
            }

            // Load factures on page load
            var initialPayeurId = $('#payenc').val();
            loadFactures(initialPayeurId);
            ChargeAccount(initialPayeurId);

            // Reload factures when the payeur is changed
            $('#payenc').change(function () {
                var selectedPayeurId = $(this).val();
                loadFactures(selectedPayeurId);
            });
        });


        function checksomme() {
            let montantTot = parseFloat($('#montantenc').val());
            let accountTot = parseFloat($('#accountsomme').data('value'));
            let montantRestant = montantTot;
            let accountRestant = accountTot;

            selectedFactures.forEach(function (facture) {
                let restantElem = $(`#restant_${facture.id}`);
                let factureMontant = facture.montant;

                // Deduct from montantRestant first
                if (montantRestant >= factureMontant) {
                    restantElem.html("0.00 DA");
                    montantRestant -= factureMontant;
                } else if (montantRestant > 0) {
                    factureMontant -= montantRestant;
                    montantRestant = 0;

                    // Now deduct the remaining factureMontant from accountRestant
                    if (accountRestant >= factureMontant) {
                        restantElem.html("0.00 DA");
                        accountRestant -= factureMontant;
                    } else {
                        restantElem.html(formatNumber(factureMontant - accountRestant) + " DA");
                        accountRestant = 0;
                    }
                } else {
                    // If montantRestant is 0, start deducting directly from accountRestant
                    if (accountRestant >= factureMontant) {
                        restantElem.html("0.00 DA");
                        accountRestant -= factureMontant;
                    } else {
                        restantElem.html(formatNumber(factureMontant - accountRestant) + " DA");
                        accountRestant = 0;
                    }
                }
            });

            $('#restant_montant').html(formatNumber(montantRestant) + " DA");
            $('#restant_accompte').html(formatNumber(accountRestant) + " DA");
        }


        function handleCheckboxChange(checkbox) {
            let id = $(checkbox).attr('id').split('_')[1]; // Extract the number after "checkbox_"

            if ($(checkbox).is(':checked')) {
                // Add to the list if checked
                selectedFactures.push({
                    "id": id,
                    "montant": $("#montant_" + id).data('value')
                });
            } else {
                // Remove from the list if unchecked
                selectedFactures = selectedFactures.filter(item => item.id !== id);
            }

            checksomme()
        }

        function ChargeAccount(payeur_id) {
            $.ajax({
                url: '/encaissement/accomptetotal', // API endpoint for accomptetotal
                method: 'GET',
                data: {
                    payeur_id: payeur_id
                },
                success: function (response) {
                    // Handle the response here
                    // Example: update some element with the data
                    $('#accountsomme').html(formatNumber(response) + " DA");
                    $('#accountsomme').attr('data-value', response);
                },
                error: function (error) {
                    console.log("Error fetching accomptetotal data:", error);
                }
            });
        }


        $('#addenc').on('click', function () {
            // Extracting just the IDs from selectedFactures
            var factureIds = selectedFactures.map(function (facture) {
                return parseInt(facture.id);
            });

            var listefacturesub = [];

            if ($('#encaissementSubstitution').is(':checked')) {
                listefacturesub = $('#creance_subfacpayeur').val();
            } else listefacturesub = null;

            alert($('input[name="options"]:checked').val());

            if ($('input[name="options"]:checked').val() === "Espece") {
                var encaissementData = {
                    montant: $('#montantenc').val(),
                    payeur: $('#payenc').val(),
                    type: $('input[name="options"]:checked').val(),
                    substitution: $('#encaissementSubstitution').is(':checked'),
                    listefacturesub: listefacturesub, // Send the selected factures or empty if unchecked
                    factures: factureIds // Sending only the IDs
                };
            } else {
                var encaissementData = {
                    montant: $('#montantenc').val(),
                    payeur: $('#payenc').val(),
                    type: $('input[name="options"]:checked').val(),
                    numero: $('#numeroenc').val(),
                    banque: $('#banqueenc').val(),
                    date_depot: $('#datedepot').val(),
                    date_cheque: $('#datevalisation').val(),
                    substitution: $('#encaissementSubstitution').is(':checked'),
                    listefacturesub: listefacturesub, // Send the selected factures or empty if unchecked
                    factures: factureIds // Sending only the IDs
                };
            }


            // Retrieve the CSRF token from the form input
            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val(); // Adjust selector if necessary

            var settings = {
                "url": '/api/encaissement/', // Replace with your actual API endpoint
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "X-CSRFToken": csrftoken // Set the CSRF token in the header
                },
                "contentType": "application/json",
                "data": JSON.stringify(encaissementData)
            };

            $.ajax(settings)
                .done(function (response) {
                    console.log(response);
                    alert('Encaissement ajouté avec succès');
                    window.location.href = "/users";
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    console.log('jqXHR:', jqXHR);

                    console.log('Status:', textStatus);

                    console.log('Error Thrown:', errorThrown);

                    console.log('Response Text:', jqXHR.responseText);

                    try {
                        var responseJSON = JSON.parse(jqXHR.responseText);
                        console.log('Response JSON:', responseJSON);
                    } catch (e) {
                        console.error('Failed to parse response as JSON:', e);
                    }

                    alert('Erreur lors de l\'ajout de l\'encaissement');
                });
        });


        $(document).ready(function () {
            $('input[name="options"]').on('change', function () {
                console.log("ici");
                console.log($(this).val());

                if ($(this).val() === 'Espece') {
                    console.log("voila");
                    // Disabling the fields
                    $('#banqueenc').prop('disabled', true);
                    $('#numeroenc').prop('disabled', true);
                } else {
                    // Enabling the fields
                    $('#banqueenc').prop('disabled', false);
                    $('#numeroenc').prop('disabled', false);
                }
            });
        });



    </script>


{% endblock %}
