{% extends "baseNew.html" %}
{% load mes_tags %}
{% load static %}
{% block title %}Commandes{% endblock %}

{% block content %}
    <style>
        .hiddenelem {
            display: none;
        }
    </style>

    <div class="w-full h-full backprimer px-4 pb-4 flex flex-col">
        <!-- Add Produit Sidebar -->
        <div id="addSidebar" style="margin-top: -10px"
             class="fixed right-0 top-0 bottom-0 w-4/5 backprimer shadow-lg transform translate-x-full transition-transform duration-300 z-50">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold textslate">Ajouter une commande</h3>
                <button id="closeSidebar" class="text-xl textslate text-md">&times;</button>
            </div>
            <!-- Step 1: Select Products -->
            <div id="step1" class="p-4 containerdef flex flex-col">
                <div class="p-4 h-28 flex justify-around border border-gray-300 rounded-lg mb-4 gap-4">
                    <!-- Type Filter -->
                    <div class="mb-4 w-64">
                        <label for="typeFilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Type</label>
                        <select id="typeFilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for fil in liste_type %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Measure Filter -->
                    <div class="mb-4 w-64">
                        <label for="measureFilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Mesure</label>
                        <select id="measureFilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">

                            {% for fil in liste_mesure %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field Filter -->
                    <div class="mb-4 w-64">
                        <label for="colorfilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Couleur</label>
                        <select id="colorfilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">

                            {% for fil in liste_couleur %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field Filter -->
                    <div class="mb-4 w-64">
                        <label for="distfield" class="block text-sm font-medium text-gray-700 mb-2 textslate">Selectionner
                            le distributeur</label>
                        <select id="distfield"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for em in liste_distributeur %}
                                <option data-designation="{{ em.designation }}" data-username="{{ em.nom }}"
                                        data-email="{{ em.email }}"
                                        id="{{ em.id }}" value="{{ em.id }}">{{ em.nom }} ({{ em.designation }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>


                </div>
                <div class="overflow-y-auto flex-grow">
                    <div id="productList" class="grid gap-4 w-full"></div>
                </div>

                <div class="h-12 flex justify-end pt-2">
                    <button id="goToStep2" class="goToStep2 h-10 bg-blue-500 text-white px-4 py-2 rounded-lg">Suivant
                    </button>
                </div>

            </div>

            <!-- Step 2: Review Selected Products -->
            <div id="step2" class="p-4 containerdef flex flex-col">
                <div class="h-7 text-lg font-semibold mb-4 defaultboldval">
                    Liste des produits sélectionnes
                </div>

                <!--<h3 class="text-lg font-semibold mb-4 defaultboldval bg-blue-300">Liste des produits sélectionnes</h3>-->

                <!-- <div class="overflow-y-auto flex-grow">
                    <div id="productList" class="grid gap-4 w-full"></div>
                </div> -->
                <div class="overflow-y-auto flex-grow">
                    <div id="selectedProducts"></div>
                </div>

                <div class="h-12 flex justify-end font-bold">
                    <div class="grid grid-cols-4">
                        <div class="defaultboldval">Total HT:</div>
                        <div class="text-right col-span-3 defaultboldval" id="totalPrice">0 DA</div>

                        <div class="defaultboldval">Total TTC:</div>
                        <div class="text-right col-span-3 defaultboldval" id="totalPriceTTC">0 DA</div>
                    </div>
                </div>

                <div class="h-12 flex justify-between pt-2 items-center">
                    <button id="goToStep1" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                    <button id="goToStep3" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Suivant</button>
                </div>
            </div>

            <!-- Step 3: Confirm Order -->
            <div id="step3" class="p-4 containerdef flex flex-col defaultboldval">
                <!-- Logo Section -->
                <div class="flex-grow w-full flex flex-col items-center">

                    <div class="w-2/3">
                        <div class="flex justify-center mb-4">
                            <img src="{% static 'images/puma.svg' %}" alt="Company Logo" class="h-16">
                        </div>

                        <!-- Facture Details -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- Recipient Details -->
                            <div class="">
                                <p id="recipientCompany">Nom de l'entreprise</p>
                                <p id="recipientName">Nom et prénom</p>
                                <p id="recipientEmail">email@domaine.com</p>
                            </div>

                            <!-- Facture Info -->
                            <div class="text-right">
                                <!--<p id="factureCode">12345</p>-->
                                <p id="factureDate">01/01/2024</p>
                                <p id="issuerName">{{ request.user.nom }}</p>
                            </div>
                        </div>

                        <!-- Product Details Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-t border-b border-gray-300">
                                <thead>
                                <tr>
                                    <th class="p-2 text-left">Désignation & Référence</th>
                                    <th class="p-2 text-center">Prix Unitaire</th>
                                    <th class="p-2 text-center">Quantité</th>
                                    <th class="p-2 text-center">Total</th>
                                </tr>
                                </thead>
                                <tbody id="productDetails">
                                <!-- Product rows will be inserted here dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Total Section -->
                        <div class="flex justify-end">
                            <div class="mt-4 w-1/3">
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>Total:</span>
                                    <span id="totalAmount" class="pr-2">0 DA</span>
                                </div>
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>TVA:</span>
                                    <span id="taxAmount" class="pr-2">0 DA</span>
                                </div>
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>Montant Total:</span>
                                    <span id="amountDue" class="pr-2">0 DA</span>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Buttons -->
                <div class="h-12 flex justify-between pt-2 items-center">
                    <button class="goToStep2 bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                    <button id="confirmOrder" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Confirmer</button>
                </div>
            </div>

        </div>

        <!-- edit Produit Sidebar -->
        <div id="editSidebar" style="margin-top: -10px"
             class="fixed right-0 top-0 bottom-0 w-4/5 backprimer shadow-lg transform translate-x-full transition-transform duration-300 z-50">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold textslate">Editer commande</h3>
                <button id="closeEditSidebar" class="text-xl textslate text-md">&times;</button>
            </div>
            <!-- Step 1: Select Products -->
            <div id="editstep1" class="p-4 containerdef flex flex-col">
                <div class="p-4 h-28 flex justify-around border border-gray-300 rounded-lg mb-4 gap-4">
                    <!-- Type Filter -->
                    <div class="mb-4 w-64">
                        <label for="edittypeFilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Type</label>
                        <select id="edittypeFilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for fil in liste_type %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Measure Filter -->
                    <div class="mb-4 w-64">
                        <label for="editmeasureFilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Mesure</label>
                        <select id="editmeasureFilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">

                            {% for fil in liste_mesure %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field Filter -->
                    <div class="mb-4 w-64">
                        <label for="editcolorfilter"
                               class="block text-sm font-medium text-gray-700 mb-2 textslate">Couleur</label>
                        <select id="editcolorfilter"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">

                            {% for fil in liste_couleur %}
                                <option value="{{ fil.id }}">{{ fil.designation }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field Filter -->
                    <div class="mb-4 w-64">
                        <label for="editdistfield" class="block text-sm font-medium text-gray-700 mb-2 textslate">Selectionner
                            le
                            distributeur</label>
                        <select id="editdistfield"
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for fil in liste_distributeur %}
                                <option data-designation="{{ fil.designation }}" data-username="{{ fil.user.nom }}"
                                        data-email="{{ fil.user.email }}"
                                        id="{{ fil.id }}" value="{{ fil.id }}">{{ fil.designation }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>


                </div>
                <div class="overflow-y-auto flex-grow">
                    <div id="editproductList" class="grid gap-4 w-full"></div>
                </div>

                <div class="h-12 flex justify-end pt-2">
                    <button id="editgoToStep2" class="editgoToStep2 h-10 bg-blue-500 text-white px-4 py-2 rounded-lg">
                        Suivant
                    </button>
                </div>

            </div>

            <!-- Step 2: Review Selected Products -->
            <div id="editstep2" class="p-4 containerdef flex flex-col">
                <div class="h-7 text-lg font-semibold mb-4 defaultboldval">
                    Liste des produits sélectionnes
                </div>

                <!--<h3 class="text-lg font-semibold mb-4 defaultboldval bg-blue-300">Liste des produits sélectionnes</h3>-->

                <!-- <div class="overflow-y-auto flex-grow">
                    <div id="productList" class="grid gap-4 w-full"></div>
                </div> -->
                <div class="overflow-y-auto flex-grow">
                    <div id="editselectedProducts"></div>
                </div>

                <div class="h-12 flex justify-end font-bold">
                    <div class="grid grid-cols-4">
                        <div class="defaultboldval">Total HT:</div>
                        <div class="text-right col-span-3 defaultboldval" id="edittotalPrice">0 DA</div>

                        <div class="defaultboldval">Total TTC:</div>
                        <div class="text-right col-span-3 defaultboldval" id="edittotalPriceTTC">0 DA</div>
                    </div>
                </div>

                <div class="h-12 flex justify-between pt-2 items-center">
                    <button id="editgoToStep1" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                    <button id="editgoToStep3" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Suivant</button>
                </div>
            </div>

            <!-- Step 3: Confirm Order -->
            <div id="editstep3" class="p-4 containerdef flex flex-col defaultboldval">
                <!-- Logo Section -->
                <div class="flex-grow w-full flex flex-col items-center">

                    <div class="w-2/3">
                        <div class="flex justify-center mb-4">
                            <img src="{% static 'images/puma.svg' %}" alt="Company Logo" class="h-16">
                        </div>

                        <!-- Facture Details -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- Recipient Details -->
                            <div class="">
                                <p id="editrecipientCompany">Nom de l'entreprise</p>
                                <p id="editrecipientName">Nom et prénom</p>
                                <p id="editrecipientEmail">email@domaine.com</p>
                            </div>

                            <!-- Facture Info -->
                            <div class="text-right">
                                <!--<p id="factureCode">12345</p>-->
                                <p id="editfactureDate">01/01/2024</p>
                                <p id="editissuerName">{{ request.user.nom }}</p>
                            </div>
                        </div>

                        <!-- Product Details Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-t border-b border-gray-300">
                                <thead>
                                <tr>
                                    <th class="p-2 text-left">Désignation & Référence</th>
                                    <th class="p-2 text-center">Prix Unitaire</th>
                                    <th class="p-2 text-center">Quantité</th>
                                    <th class="p-2 text-center">Total</th>
                                </tr>
                                </thead>
                                <tbody id="editproductDetails">
                                <!-- Product rows will be inserted here dynamically -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Total Section -->
                        <div class="flex justify-end">
                            <div class="mt-4 w-1/3">
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>Total:</span>
                                    <span id="edittotalAmount" class="pr-2">0 DA</span>
                                </div>
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>TVA:</span>
                                    <span id="edittaxAmount" class="pr-2">0 DA</span>
                                </div>
                                <div class="flex justify-between mt-2 font-semibold">
                                    <span>Montant Total:</span>
                                    <span id="editamountDue" class="pr-2">0 DA</span>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Buttons -->
                <div class="h-12 flex justify-between pt-2 items-center">
                    <button class="editgoToStep2 bg-gray-500 text-white px-4 py-2 rounded-lg">Retour</button>
                    <button id="editconfirmOrder" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Confirmer</button>
                </div>
            </div>

        </div>

        <div class="flex justify-between items-center pt-4 mb-4" style="margin-top: -8px">
            <div class="flex gap-2">
                <div>
                    <a href="{% url 'commande' %}"
                       class="block px-4 py-2 actualprimer rounded">Commandes</a>
                </div>
                <div><!-- accomptes -->
                    <a href="{% url 'bl' %}" class="block px-4 py-2 hoverprimer rounded">Bon de livraison</a>
                </div>
            </div>
            <div>
                <button id="filterButton" class="btn capitalize backprimer px-4 py-2 border border-slate-300 text-gray-400
                    hover:bg-blue-900 hover:border-slate-400 rounded-md">Filtrer
                </button>

                {% if 'add_dist_commande' in listeauth %}
                    <button id="addButton" class="btn capitalize backprimer px-4 py-2 border border-slate-300 text-gray-400
                        hover:bg-blue-900 hover:border-slate-400 rounded-md">Ajouter
                    </button>
                {% else %}
                    <button class="btn capitalize bg-gray-500 text-white px-4 py-2 border rounded-md cursor-not-allowed">
                        Ajouter
                    </button>
                {% endif %}

            </div>
        </div>
        <hr/>

        <!-- Produit List Headers -->
        <div class="pt-4">
            <div class="flex items-center justify-between text-gray-600 font-semibold px-4 defaultboldval">
                <div class="w-1/6 capitalize">Code</div>
                <div class="w-1/4 capitalize">Distributeur</div>
                <div class="w-1/6 capitalize">Ville</div>
                <div class="w-1/6 capitalize">Date</div>
                <div class="w-1/6 capitalize px-4">Total CMD</div>
                <div class="w-1/6 capitalize px-4">Total BL</div>
                <div class="w-1/6 capitalize text-center">Etat</div>
                <div class="w-1/6 capitalize text-center">Actions</div>
            </div>
        </div>

        <div class="flex-grow shadow-md rounded-b-lg backslateprime p-2 overflow-y-auto">
            {% for elem in liste_cmd %}
                <div class="flex items-center justify-between p-2 backslateslite flex-none mb-2">
                    <div class="w-1/6">
                        <p class="text-sm textslate">{{ elem.code }}</p>
                    </div>
                    <div class="w-1/4">
                        <p class="text-sm textslate">{{ elem.distributeur }}</p>
                    </div>
                    <div class="w-1/6">
                        <p class="text-sm textslate">{{ elem.ville }}</p>
                    </div>
                    <div class="w-1/6">
                        <p class="text-sm textslate">{{ elem.date_ajout|date:'d-m-Y' }}</p>
                    </div>
                    <div class="w-1/6 border-r-2 border-gray-700">
                        <div class="flex w-full justify-between pr-2">
                            <div class="text-sm textslate">HT:</div>
                            <div class="text-sm textslate text-right">{{ elem.total|floate_redefined }} DA</div>
                        </div>
                        <div class="flex w-full justify-between pr-2">
                            <div class="text-sm textslate">Taxe:</div>
                            <div class="text-sm textslate text-right">{{ elem.taxedtotal|floate_redefined }} DA</div>
                        </div>
                    </div>
                    <div class="w-1/6">
                        <div class="flex w-full justify-between pl-2">
                            <div class="text-sm textslate">HT:</div>
                            <div class="text-sm textslate text-right">{{ elem.total_blivraison|floate_redefined }} DA
                            </div>
                        </div>
                        <div class="flex w-full justify-between pl-2">
                            <div class="text-sm textslate">Taxe:</div>
                            <div class="text-sm textslate text-right">{{ elem.taxedtotal_blivraison|floate_redefined }}
                                DA
                            </div>
                        </div>
                    </div>
                    <div class="w-1/6 flex justify-center items-center">
                        <div
                                class='
                        {% if elem.etat == "Brouillon" %} bluedot
                        {% elif elem.etat == "Reception" %} reddot
                        {% elif elem.etat == "Traitement" %} yellowdot
                        {% elif elem.etat == "Preparation" %} greendot
                        {% elif elem.etat == "Complete" %} violetdot
                        {% elif elem.etat == "En cours" %} orangedot
                        {% else %} graydot
                        {% endif %}
                        w-2 h-2 rounded-full text-red-600 capitalize tooltip text-xs mr-2'
                                data-tip="{{ elem.etat }}">
                        </div>
                        <div class="text-sm textslate text-center">{{ elem.etat }}</div>
                    </div>

                    <!-- <div class="flex space-x-2 w-1/6 justify-end group">
                        <button class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Actions
                            <svg class="w-5 h-5 ml-2 -mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M5.292 7.292a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
        
                        <div class="dropdownMenu absolute right-4 z-10 hidden w-56 mt-8 origin-top-right backslate divide-y divide-gray-100 rounded-md shadow-lg ring-1 ring-black ring-opacity-5">
                            <div class="py-1">
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 popupButton" id="popupButton"
                                    data-identifiant="{ { elem.id }}">Ajoout BL
                                </a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 viewButton" id="viewButton"
                                    data-identifiant="{ { elem.id }}">Voir détail</a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 editButton" id="editButton"
                                    data-identifiant="{ { elem.id }}">Éditer</a>
                                <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" id="supButton"
                                    data-identifiant="{ { elem.id }}">Supprimer</a>
                            </div>
                        </div>
                    </div>
        -->
                    <div class="flex space-x-2 w-1/6 justify-end">

                        {% if elem.etat == 'Reception' %}
                            <div class="bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}"><i
                                    class="fa-solid fa-truck"></i>
                            </div>

                            {% if "view_dist_commande" in listeauth %}
                                <button id="viewButton"
                                        class="viewButton bg-blue-500 text-white p-2 rounded viewelem_{{ elem.id }}"
                                        data-identifiant="{{ elem.id }}" data-etat="{{ elem.etat }}"><i
                                        class="fas fa-search"></i></button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed viewelem_{{ elem.id }}"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-search"></i>
                                </div>
                            {% endif %}

                            {% if "change_dist_commande" in listeauth %}
                                <button id="editButton" class="editButton bg-blue-500 text-white p-2 rounded"
                                        data-identifiant="{{ elem.id }}">
                                    <i class="fas fa-pencil-alt" onclick=""></i>
                                </button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-pencil-alt"></i>
                                </div>
                            {% endif %}

                            {% if 'delete_dist_commande' in listeauth %}
                                <button class="bg-red-500 text-white p-2 rounded delete-btn"
                                        data-identifiant="{{ elem.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-trash"></i>
                                </div>
                            {% endif %}


                        {% elif elem.etat in 'Traitement, Preparation' %}
                            <div class="bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}"><i
                                    class="fa-solid fa-truck"></i>
                            </div>

                            {% if 'view_dist_commande' in listeauth %}
                                <button id="viewButton"
                                        class="viewButton bg-blue-500 text-white p-2 rounded viewelem_{{ elem.id }}"
                                        data-identifiant="{{ elem.id }}" data-etat="{{ elem.etat }}"><i
                                        class="fas fa-search"></i></button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed viewelem_{{ elem.id }}"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-search"></i>
                                </div>
                            {% endif %}

                            <div class=" bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}">
                                <i class="fas fa-pencil-alt" onclick=""></i>
                            </div>

                            <div class="bg-gray-300 text-white p-2 rounded">
                                <i class="fas fa-trash"></i>
                            </div>

                        {% elif elem.etat == 'En cours' %}
                            {% if 'add_dist_bonlivraison' in listeauth %}
                                <button id="popupButton" class="popupButton bg-blue-500 text-white p-2 rounded"
                                        data-identifiant="{{ elem.id }}">
                                    <i class="fa-solid fa-truck"></i>
                                </button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fa-solid fa-truck"></i>
                                </div>
                            {% endif %}

                            {% if "view_dist_commande" in listeauth %}
                                <button id="viewButton"
                                        class="viewButton bg-blue-500 text-white p-2 rounded viewelem_{{ elem.id }}"
                                        data-identifiant="{{ elem.id }}" data-etat="{{ elem.etat }}"><i
                                        class="fas fa-search"></i></button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed viewelem_{{ elem.id }}"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-search"></i>
                                </div>
                            {% endif %}

                            <div class=" bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}">
                                <i class="fas fa-pencil-alt" onclick=""></i>
                            </div>

                            <div class="bg-gray-300 text-white p-2 rounded">
                                <i class="fas fa-trash"></i>
                            </div>

                        {% elif elem.etat in 'Complete, Annule' %}


                            <div class=" bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}"><i
                                    class="fa-solid fa-truck"></i>
                            </div>

                            {% if "view_dist_commande" in listeauth %}
                                <button id="viewButton"
                                        class="viewButton bg-blue-500 text-white p-2 rounded viewelem_{{ elem.id }}"
                                        data-identifiant="{{ elem.id }}" data-etat="{{ elem.etat }}"><i
                                        class="fas fa-search"></i></button>
                            {% else %}
                                <div class="bg-gray-300 text-white p-2 rounded cursor-not-allowed viewelem_{{ elem.id }}"
                                     data-identifiant="{{ elem.id }}"><i
                                        class="fas fa-search"></i>
                                </div>
                            {% endif %}

                            <div class=" bg-gray-300 text-white p-2 rounded"
                                 data-identifiant="{{ elem.id }}">
                                <i class="fas fa-pencil-alt" onclick=""></i>
                            </div>

                            <div class="bg-gray-300 text-white p-2 rounded">
                                <i class="fas fa-trash"></i>
                            </div>
                        {% endif %}


                    </div>

                </div>
            {% endfor %}
        </div>


        <div id="deleteModal" class="fixed inset-0 flex items-center justify-center hidden bg-gray-800 bg-opacity-50">
            <div class="backslate p-4 rounded-lg w-96 backprimer">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Confirm Delete</h2>
                <p>Etes vous sure de vouloir supprimer cette commande?</p>
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="cancelDelete" class="px-4 py-2 bg-gray-300 rounded">Annuler</button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-500 text-white rounded">Supprimer</button>
                </div>
            </div>
        </div>

        <!-- View Sidebar -->
        <div id="viewSidebar" style="margin-top: -10px"
             class="flex flex-col fixed right-0 top-0 bottom-0 w-4/5 backprimer shadow-lg transform translate-x-full transition-transform duration-300 z-50">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold textslate">Détail Commande</h3>
                <button id="closeViewSidebar" class="text-xl textslate hover:text-gray-700">&times;</button>
            </div>

            <div id="containerdatacmd" class="flex-grow flex flex-col p-8">

            </div>


        </div>

        <!-- Pop up -->
        <div id="addbl" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
            <form>
                <div class="relative w-screen h-screen flex justify-center items-center">
                    <div class="backprimer textslate w-3/4 h-3/4 p-6 rounded-lg shadow-lg flex flex-col gap-y-2">
                        <h3 class="text-lg font-semibold">Ajout BL</h3>


                        <!-- div list products -->
                        <div class="grid grid-cols-8 text-gray-600 font-semibold px-4 capitalize">
                            <div class="col-span-2">Produit</div>
                            <div class="col-span-1">Type/Mesure</div>
                            <div class="col-span-1">Couleur</div>
                            <div class="col-span-1">Prix unitaire</div>
                            <div class="col-span-1">Quantité restante</div>
                            <div class="col-span-1">Quantité à livrer</div>
                            <div class="col-span-1 text-right">Total</div>
                        </div>
                        <!--<div class="bg-blue-300 flex w-full">
                            <div class="flex-grow">Produit</div>
                            <div class="flex-grow"></div>
                            <div class="flex-grow"></div>
                            <div class="flex-grow">Type/Mesure</div>
                            <div class="flex-grow">Couleur</div>
                            <div class="flex-grow">Prix unitaire</div>
                            <div class="flex-grow">Quantité restante</div>
                            <div class="flex-grow">Quantité a livré</div>
                            <div class="flex-grow">Total</div>
                        </div>-->
                        <div class="listeblprod flex-grow shadow-md rounded-b-lg backslateprime p-2 overflow-y-auto defaultval"
                             id="listeblprod">
                        </div>
                        <div class="grid grid-cols-8 pr-4 text-lg gap-4">
                            <div class="col-span-6 grid grid-cols-2 gap-4">
                                <div class="flex items-center space-x-4 border border-gray-300 rounded-lg fileinputback">
                                    <label for="file-upload" class="block flex-shrink-0">
                                        <div class="flex items-center justify-center px-4 py-1 rounded-l-lg backslate text-blue-500 cursor-pointer
                                    hover:bg-blue-500 hover:text-white transition-colors duration-300">
                                            <span>Fichier FC</span>
                                        </div>
                                        <input id="file-upload" type="file" class="hidden"/>
                                    </label>
                                    <span id="file-name" class="text-gray-800 truncate">No fc file</span>
                                </div>

                                <div class="flex items-center justify-center space-x-4">
                                    <input id="facture_id" class="border border-gray-300 w-full
                                    text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block
                                    p-2.5" placeholder="Facture"/>
                                </div>

                                <div class="flex items-center space-x-4 border border-gray-300 rounded-lg fileinputback">
                                    <label for="file-upload2" class="block flex-shrink-0">
                                        <div class="flex items-center justify-center px-4 py-1 rounded-l-lg backslate text-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white transition-colors duration-300">
                                            <span>Fichier BL</span>
                                        </div>
                                        <input id="file-upload2" type="file" class="hidden"/>
                                    </label>
                                    <span id="file-name2" class="text-gray-800 truncate">No bl file</span>
                                </div>

                                <select id="payeur_bl"
                                        class="mt-1 p-2 block w-full shadow-sm sm:border-gray-300 rounded-md">

                                </select>


                            </div>
                            <div class="col-span-2 grid grid-cols-2 items-center">
                                <div class="col-span-1">Total HT:</div>
                                <div class="col-span-1 text-right" id="totalhtbl">0 DA</div>
                                <div class="col-span-1">Total Taxe:</div>
                                <div class="col-span-1 text-right" id="totaltaxebl">0 DA</div>
                            </div>

                        </div>

                        <div class="flex justify-between">
                            <div class="">
                                <button type="button" id="closePopup"
                                        class="bg-gray-500 text-white px-4 py-2 rounded-lg">
                                    Annuler
                                </button>
                            </div>


                            <div class="">
                                <input type="submit" class="btn capitalize backprimer px-4 py-2 border border-slate-300 text-gray-400
                        hover:bg-blue-900 hover:border-slate-400 rounded-md" style="color: #FFFFFF!important;"
                                       id="validatebl"
                                       value="Valider">
                            </div>
                        </div>


                    </div>
                </div>
            </form>

        </div>
    </div>


    <div id="filterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 flex items-center justify-center"
         style="margin-top: -16px">
        <div class="backprimer w-1/3 rounded-lg shadow-lg">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Filtres</h3>
                <button id="closeFilterModal" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-4">
                <div class="mb-3">
                    <label for="distributeur_filter"
                           class="block mb-1 pl-1 text-sm font-medium textslate">Distributeur:</label>
                    <select id="distributeur_filter"
                            class="mt-1 p-2 block w-full shadow-sm sm:border-gray-300 rounded-md">
                        <option value="" {% if request.GET.distributeur == "" %}selected{% endif %}>Tous</option>
                        {% for dist in liste_distributeur %}
                            <option value="{{ dist.id }}"
                                    {% if request.GET.distributeur == dist.id|stringformat:"s" %}selected{% endif %}>{{ dist.designation }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="ville_filter" class="block mb-1 pl-1 text-sm font-medium textslate">Ville:</label>
                    <select id="ville_filter" class="mt-1 p-2 block w-full shadow-sm sm:border-gray-300 rounded-md">
                        <option value="" {% if request.GET.ville == "" %}selected{% endif %}>Tous</option>
                        {% for ville in liste_ville %}
                            <option value="{{ ville.id }}"
                                    {% if request.GET.ville == ville.id|stringformat:"s" %}selected{% endif %}>{{ ville.designation }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="etat_filter" class="block mb-1 pl-1 text-sm font-medium textslate">Etat:</label>
                    <select id="etat_filter" class="mt-1 p-2 block w-full shadow-sm sm:border-gray-300 rounded-md">
                        <option value="" {% if request.GET.etat == "" %}selected{% endif %}>Tous</option>
                        <option value="Reception" {% if request.GET.etat == "Reception" %}selected{% endif %}>
                            Reception
                        </option>
                        <option value="Traitement" {% if request.GET.etat == "Traitement" %}selected{% endif %}>
                            Traitement
                        </option>
                        <option value="Preparation" {% if request.GET.etat == "Preparation" %}selected{% endif %}>
                            Preparation
                        </option>
                        <option value="En cours" {% if request.GET.etat == "En cours" %}selected{% endif %}>En cours
                        </option>
                        <option value="Complete" {% if request.GET.etat == "Complete" %}selected{% endif %}>Complete
                        </option>
                        <option value="Annule" {% if request.GET.etat == "Annule" %}selected{% endif %}>Annule</option>
                    </select>
                </div>


                <div class="flex justify-between">
                    <button class="closePopup text-white p-2 rounded btn capitalize bg-[#141b54] hover:bg-blue-900">
                        Annuler
                    </button>
                    <button id="SearchApply"
                            class="btn capitalize bg-[#141b54] px-4 rounded py-2 border border-slate-300 text-gray-400 text-sm hover:bg-blue-900 hover:border-slate-400">
                        Lancer recherce
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- add elems -->
    <script>
        listeauth = '{{ listeauth }}';
        listeauth = JSON.parse(listeauth.replaceAll('&#x27;', '"'));


        $("#SearchApply").on('click', function (e) {
            e.preventDefault();

            link = "/commande?ville=" + $('#ville_filter').val() + "&distributeur=" + $('#distributeur_filter').val()
                + "&etat=" + $('#etat_filter').val();
            //alert(link)
            window.location.href = link;
        })


        {% if 'customuser' not in listmodules %}
            $("#userslistlink").addClass('hidden');
        {% endif %}

        {% if 'produit' not in listmodules %}
            $("#prodlistlink").addClass('hidden');
        {% endif %}

        {% if 'distributeur' not in listmodules %}
            $("#distlistlink").addClass('hidden');
        {% endif %}

        {% if 'dist_commande' not in listmodules %}
            $("#cmdlistlink").addClass('hidden');
        {% endif %}

        {% if 'encaissement' not in listmodules %}
            $("#enclistlink").addClass('hidden');
        {% endif %}

        {% if 'formation' not in listmodules %}
            $("#formslistlink").addClass('hidden');
        {% endif %}

        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);
        }


        var selectedProducts = [];
        var editselectedProducts = [];
        var $containerdatacmd = $('#containerdatacmd');

        $('#addButton').click(function () {
            $('#addSidebar').removeClass('translate-x-full').addClass('translate-x-0');
            $('#step1').show();
            $('#step2, #step3').hide();
        });


        $('#closeEditSidebar').on('click', function () {
            $('#editSidebar').addClass('translate-x-full');
        });


        $(document).on('click', function (e) {
            if (!$(e.target).closest('#editButton, #editSidebar').length) {
                $('#editSidebar').addClass('translate-x-full');
            }
        });


        $('#closeSidebar').click(function () {
            $('#addSidebar').removeClass('translate-x-0').addClass('translate-x-full');
        });

        $('#filterButton').click(function () {
            $('#filterModal').removeClass('hidden');
        });

        $('#closeFilterModal').click(function () {
            $('#filterModal').addClass('hidden');
        });

        $('.goToStep2').click(function () {
            $('#step1').hide();
            $('#step2').show();
        });

        $('#goToStep1').click(function () {
            $('#step2').hide();
            $('#step1').show();
        });

        $('#closeViewSidebar').on('click', function () {
            $('#viewSidebar').addClass('translate-x-full');
        });

        $('#goToStep3').click(function () {
            var selectedDistributor = $('#distfield option:selected');
            var distributorName = selectedDistributor.data('username');
            var distributorCompany = selectedDistributor.data('designation');
            var distributorEmail = selectedDistributor.data('email');


            $('#recipientCompany').text(distributorCompany);
            $('#recipientName').text(distributorName);
            $('#recipientEmail').text(distributorEmail);

            // Generate a fake facture code and date for now
            /*var factureCode = 'FAC-' + Math.floor(Math.random() * 1000000);
    
            $('#factureCode').text(factureCode);*/
            var currentDate = new Date().toLocaleDateString('fr-FR');
            $('#factureDate').text(currentDate);

            // Populate the product details in the facture
            var factureProductDetails = '';
            var totalAmount = 0;

            selectedProducts.forEach(product => {
                const productName = product.designation;
                const productRef = product.reference;
                const productPrice = formatNumber(product.prixunitaire) + ' DA';
                const productQuantity = product.quantity;
                const productTotal = formatNumber(product.total) + ' DA';

                totalAmount += product.total;

                factureProductDetails += `
                <tr class="defaultboldval">
                    <td class="p-2">${productName} (${productRef})</td>
                    <td class="p-2 text-right">${productPrice}</td>
                    <td class="p-2 text-right">${productQuantity}</td>
                    <td class="p-2 text-right">${productTotal}</td>
                </tr>
            `;
            });


            $('#productDetails').html(factureProductDetails);

            // Calculate and display the totals
            var taxRate = 0.19; // Example tax rate of 19%
            var taxAmount = totalAmount * taxRate;
            var amountDue = totalAmount + taxAmount;

            $('#totalAmount').text(formatNumber(totalAmount) + ' DA');
            $('#taxAmount').text(formatNumber(taxAmount) + ' DA');
            $('#amountDue').text(formatNumber(amountDue) + ' DA');

            $('#step2').hide();
            $('#step3').show();

            // Display selected products in step 3
            /*$('#productDetails').empty();
            let totalPrice = 0;
            selectedProducts.forEach(function (product) {
                $('#productDetails').append(`
                    <tr>
                        <td class="p-2 text-left">${product.designation} & ${product.reference}</td>
                        <td class="p-2 text-center">${formatNumber(product.prixunitaire)} DA</td>
                        <td class="p-2 text-center">${product.quantity}</td>
                        <td class="p-2 text-center">${formatNumber(product.total)} DA</td>
                    </tr>
                `);
                totalPrice += product.total;
            });
            $('#totalPriceStep3').text(`${formatNumber(totalPrice)} DA`);
            const taxAmount = totalPrice * 0.19;
            $('#taxAmountStep3').text(`${formatNumber(taxAmount)} DA`);
            $('#amountDueStep3').text(`${formatNumber(totalPrice + taxAmount)} DA`);*/
        });

        $(document).ready(function () {
            function fetchProducts() {
                var settings = {
                    "url": "/api/products?active=true&typeproduit=" + $('#typeFilter').val() + "&mesure_id=" + $('#measureFilter').val() + "" +
                        "&couleur_produit=" + $('#colorfilter').val(),
                    "method": "GET",
                    "timeout": 0,
                    "headers": {
                        "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                    },
                };

                $.ajax(settings).done(function (response) {
                    $('#productList').empty();

                    response.forEach(function (product) {
                        var prix_publiqueformat = formatNumber(product.prix_publique);
                        var productId = product.produit_id;

                        // Find the selected product from the array
                        var selectedProduct = selectedProducts.find(p => p.id === productId);
                        var quantity = selectedProduct ? selectedProduct.quantity : 0;
                        var isSelected = quantity > 0;
                        var prixttc = product.prix_publique + product.prix_publique * 0.19;

                        var productHtml = `
                        <div class="text-xs grid grid-cols-12 items-center justify-between ${isSelected ? 'backslate defaultdark' : 'backslateslite text-slate'} p-2 rounded-lg product-row"
                            data-price="${product.prix_publique}" data-product-id="${productId}">
                            <div class="flex items-center col-span-3">
                                <img src="/media/${product.image || 'default_image.png'}" alt="Avatar" class="h-12 w-12 rounded-lg mr-4 imageprod">
                                <div>
                                    <h3 class="text-md font-bold text-blue-600 nameprod">${product.designation}</h3>
                                    <p class="text-gray-800 refprod">${product.reference}</p>
                                </div>
                            </div>

                            <div class="col-span-3 grid grid-cols-3 gap-x-2">
                                <div class="col-span-3 typeprod">${product.typeproduit_designation}</div>
                                <div class="col-span-1 mesureprod">${product.mesure_designation}</div>
                                <div class="col-span-2 colorprod">${product.couleur}</div>
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2 pl-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 priceprod text-right pr-4 font-bold" data-value="${product.prix_publique}">
                                    ${prix_publiqueformat} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 priceprodttc font-bold" data-value="${product.prix_publique}">
                                    ${formatNumber(prixttc)} DA
                                </div>
                            </div>

                            <div class="col-span-2 pr-2">
                                <input type="number" class="numbprod product-quantity bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="${quantity}" min="0" />
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 product-total text-right pr-4 font-bold">
                                    ${formatNumber(quantity * product.prix_publique)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 product-totalttc font-bold">
                                    ${formatNumber(quantity * product.prix_publique + (quantity * product.prix_publique * 0.19))} DA
                                </div>
                            </div>
                        </div>
                    `;

                        $('#productList').append(productHtml);


                    });
                });
            }


            // Fetch products initially
            fetchProducts();

            // Attach event listeners to filter fields
            $('#typeFilter, #measureFilter, #colorfilter').on('change', function () {
                fetchProducts();
            });

            // Example code for handling input change (for completeness)
            $(document).on('input', '.product-quantity', function () {
                var productRow = $(this).closest('.product-row');
                var quantity = parseInt($(this).val()) || 0;  // Ensure valid integer
                var productId = productRow.data('product-id');
                var prixunitaire = parseFloat(productRow.find('.priceprod').data('value'));
                var total = prixunitaire * quantity;
                var totalttc = total + total * 0.19;

                // Update the product total in the first slider
                if (quantity >= 1) {
                    productRow.find('.product-total').text(`${formatNumber(total)} DA`);
                    productRow.find('.product-totalttc').text(`${formatNumber(totalttc)} DA`);

                    productRow.removeClass("backslateslite");
                    productRow.removeClass("text-slate");
                    productRow.addClass("backslate");
                    productRow.addClass("defaultdark");
                    // Add or update in selectedProducts list
                    var existingProduct = selectedProducts.find(p => p.id === productId);
                    if (existingProduct) {
                        existingProduct.quantity = quantity;
                        existingProduct.total = total;

                        // Update the second slider if the product is already added
                        var secondSliderRow = $('#selectedProducts .product-row[data-product-id="' + productId + '"]');
                        secondSliderRow.find('.product-quantity').val(quantity);
                        secondSliderRow.find('.product-total').text(`${formatNumber(total)} DA`);
                        secondSliderRow.find('.product-totalttc').text(`${formatNumber(totalttc)} DA`);
                    } else {
                        selectedProducts.push({
                            id: productId,
                            designation: productRow.find('.nameprod').text(),
                            reference: productRow.find('.refprod').text(),
                            type: productRow.find('.typeprod').html(),
                            mesure: productRow.find('.mesureprod').html(),
                            couleur: productRow.find('.colorprod').html(),
                            prixunitaire: prixunitaire,
                            quantity: quantity,
                            total: total,
                            img: productRow.find('img').attr('src')
                        });

                        // Add the product to the second slider
                        $('#selectedProducts').append(
                            `<div class="relative text-xs grid grid-cols-12 items-center justify-between py-2 rounded-lg product-row mb-3
                            backslate defaultdark px-2 pr-6" data-product-id="${productId}">
                            <div class="flex items-center col-span-3">
                                <img src="${productRow.find('.imageprod').attr('src')}" alt="Avatar" class="h-12 w-12 rounded-lg mr-4">
                                <div>
                                    <h3 class="text-md font-bold text-blue-600 nameprod">${productRow.find('.nameprod').text()}</h3>
                                    <p class="text-gray-800 refprod">${productRow.find('.refprod').text()}</p>
                                </div>
                            </div>
                            <div class="col-span-3 grid grid-cols-3 gap-x-2">
                                <div class="col-span-3 typeprod">${productRow.find('.typeprod').text()}</div>
                                <div class="col-span-1 mesureprod">${productRow.find('.mesureprod').text()}</div>
                                <div class="col-span-2 colorprod">${productRow.find('.colorprod').text()}</div>
                            </div>
                            <div class="col-span-2 grid grid-cols-6 gap-x-2 pl-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 priceprod text-right pr-4 font-bold" data-value="${prixunitaire}">
                                    ${formatNumber(prixunitaire)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 priceprodttc font-bold" data-value="${prixunitaire * 0.19 + prixunitaire}">
                                    ${prixunitaire * 0.19 + prixunitaire} DA
                                </div>
                            </div>

                            <div class="col-span-2 pr-2">
                                <input type="number" class="product-quantity bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="${quantity}" min="0" />
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 product-total text-right pr-4 font-bold">
                                    ${formatNumber(total)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 product-totalttc font-bold">
                                    ${formatNumber(total + total * 0.19)} DA
                                </div>
                            </div>
                            <button class="absolute top-4 right-2 removeProduct bg-red-500 text-white p-2 rounded-lg hover:bg-red-400" data-product-id="${productId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`
                        );
                    }
                } else {
                    productRow.find('.product-total').text('0 DA');
                    productRow.find('.product-totalttc').text('0 DA');

                    productRow.addClass("backslateslite");
                    productRow.addClass("text-slate");
                    productRow.removeClass("backslate");
                    productRow.removeClass("defaultdark");

                    selectedProducts = selectedProducts.filter(p => p.id !== productId);

                    $('#selectedProducts .product-row[data-product-id="' + productId + '"]').remove();
                }

                recalculateTotals();
            });

            $(document).on('click', '.removeProduct', function () {
                var productId = $(this).data('product-id');
                var productRow = $('#productList .product-row[data-product-id="' + productId + '"]');

                // Reset quantity and deselect
                productRow.find('.product-quantity').val('0');
                productRow.removeClass('backslate');
                productRow.removeClass('defaultdark');

                productRow.find('.product-total').text('0 DA');
                productRow.find('.product-totalttc').text('0 DA');

                // Remove from selectedProducts
                selectedProducts = selectedProducts.filter(p => p.id !== productId);

                // Remove from second slider
                $(this).closest('.product-row').remove();

                recalculateTotals();
            });

            // Recalculate totals
            /*function recalculateTotals() {
                let totalPrice = 0;
                selectedProducts.forEach(function (product) {
                    totalPrice += product.total;
                });
    
                // Update the total price and tax amounts
                $('#totalPrice').text(`${formatNumber(totalPrice)} DA`);
                const taxAmount = totalPrice * 0.19;
                $('#taxAmount').text(`${formatNumber(taxAmount)} DA`);
                $('#amountDue').text(`${formatNumber(totalPrice + taxAmount)} DA`);
            }*/


            $(document).on('input', '#selectedProducts .product-quantity', function () {
                var productRow = $(this).closest('.product-row');
                var productId = productRow.data('product-id');
                var quantity = parseInt($(this).val()) || 0;  // Ensure valid integer
                var prixunitaire = parseFloat(productRow.find('.priceprod').data('value'));
                var total = prixunitaire * quantity;
                var totalttc = total + total * 0.19;

                // Update the product total in the second slider
                productRow.find('.product-total').text(`${formatNumber(total)} DA`);
                productRow.find('.product-totalttc').text(`${formatNumber(totalttc)} DA`);

                // Find the corresponding product row in the first slider and update its quantity
                var firstSliderRow = $('#productList .product-row[data-product-id="' + productId + '"]');
                firstSliderRow.find('.product-quantity').val(quantity);

                // Update total and totals in the first slider
                var firstSliderTotal = firstSliderRow.find('.priceprod').data('value') * quantity;
                var firstSliderTotalTTC = firstSliderTotal + (firstSliderTotal * 0.19);

                firstSliderRow.find('.product-total').text(`${formatNumber(firstSliderTotal)} DA`);
                firstSliderRow.find('.product-totalttc').text(`${formatNumber(firstSliderTotalTTC)} DA`);

                // Update the selectedProducts array
                var existingProduct = selectedProducts.find(p => p.id === productId);
                if (existingProduct) {
                    existingProduct.quantity = quantity;
                    existingProduct.total = total;
                }

                // Recalculate totals for both sliders
                recalculateTotals();
            });

            function recalculateTotals() {
                let totalPrice = 0;
                selectedProducts.forEach(function (product) {
                    totalPrice += product.total;
                });

                // Update the total price and tax amounts
                $('#totalPrice').text(`${formatNumber(totalPrice)} DA`);
                const taxAmount = totalPrice * 0.19;

                $('#totalPriceTTC').text(`${formatNumber(totalPrice + taxAmount)} DA`);
                $('#taxAmount').text(`${formatNumber(taxAmount)} DA`);
                $('#amountDue').text(`${formatNumber(totalPrice + taxAmount)} DA`);

                // Update the totals in step 3
                $('#totalPriceStep3').text(`${formatNumber(totalPrice)} DA`);
                const totalTaxStep3 = totalPrice * 0.19;
                $('#taxAmountStep3').text(`${formatNumber(totalTaxStep3)} DA`);
                $('#amountDueStep3').text(`${formatNumber(totalPrice + totalTaxStep3)} DA`);
            }
        });


        $('#confirmOrder').on('click', function () {
            listteproducts = [];
            for (i = 0; i < selectedProducts.length; i++) {
                listteproducts.push({
                    "produit": selectedProducts[i]['id'],
                    "quantite": parseInt(selectedProducts[i]['quantity'])
                })
            }

            var settings = {
                "url": "/api/commande/",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/json",
                    "X-CSRFToken": $('input[name= csrfmiddlewaretoken]').val(),  // Assuming you have CSRF token in your template context
                },
                "data": JSON.stringify({
                    "user": $('#distfield').val(),
                    "etat": "Reception",
                    "total": 0,
                    "commandesLines": listteproducts
                }),
            };

            $.ajax(settings)
                .done(function (response) {
                    window.location.href = "/commande/";
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Log the entire jqXHR object to see all details
                    console.log('jqXHR:', jqXHR);

                    // Log the status text
                    console.log('Status:', textStatus);

                    // Log the error thrown
                    console.log('Error Thrown:', errorThrown);

                    // Log the response text, which might contain detailed error messages
                    console.log('Response Text:', jqXHR.responseText);
                    alert(jqXHR.responseText)

                    // Optionally, parse the responseText as JSON if it's in JSON format
                    try {
                        var responseJSON = JSON.parse(jqXHR.responseText);
                        console.log('Response JSON:', responseJSON);
                    } catch (e) {
                        console.error('Failed to parse response as JSON:', e);
                    }

                });

        });


        $('.editgoToStep2').click(function () {
            $('#editstep1').hide();
            $('#editstep2').show();
        });


        $('#editgoToStep1').click(function () {
            $('#editstep2').hide();
            $('#editstep1').show();
        });

        $('#editgoToStep3').click(function () {
            var selectedDistributor = $('#editdistfield option:selected');
            var distributorName = selectedDistributor.data('username');
            var distributorCompany = selectedDistributor.data('designation');
            var distributorEmail = selectedDistributor.data('email');


            $('#editrecipientCompany').text(distributorCompany);
            $('#editrecipientName').text(distributorName);
            $('#editrecipientEmail').text(distributorEmail);

            // Generate a fake facture code and date for now
            /*var factureCode = 'FAC-' + Math.floor(Math.random() * 1000000);
    
            $('#factureCode').text(factureCode);*/
            var currentDate = new Date().toLocaleDateString('fr-FR');
            $('#editfactureDate').text(currentDate);

            // Populate the product details in the facture
            var factureProductDetails = '';
            var totalAmount = 0;

            editselectedProducts.forEach(product => {
                const productName = product.designation;
                const productRef = product.reference;
                const productPrice = formatNumber(product.prixunitaire) + ' DA';
                const productQuantity = product.quantity;
                const productTotal = formatNumber(product.total) + ' DA';

                totalAmount += product.total;

                factureProductDetails += `
                <tr>
                    <td class="p-2">${productName} (${productRef})</td>
                    <td class="p-2 text-right">${productPrice}</td>
                    <td class="p-2 text-right">${productQuantity}</td>
                    <td class="p-2 text-right">${productTotal}</td>
                </tr>
            `;
            });


            $('#editproductDetails').html(factureProductDetails);

            // Calculate and display the totals
            var taxRate = 0.19; // Example tax rate of 19%
            var taxAmount = totalAmount * taxRate;
            var amountDue = totalAmount + taxAmount;

            $('#edittotalAmount').text(formatNumber(totalAmount) + ' DA');
            $('#edittaxAmount').text(formatNumber(taxAmount) + ' DA');
            $('#editamountDue').text(formatNumber(amountDue) + ' DA');

            $('#editstep2').hide();
            $('#editstep3').show();

        });

        $(document).ready(function () {
            $('.editButton').on('click', function () {
                $('#editSidebar').toggleClass('translate-x-full');
                identifiant = $(this).data('identifiant');
                editselectedProducts = [];
                $('#editselectedProducts').html("");

                let settings = {
                    url: `/api/commandedetail/${identifiant}`,
                    method: "GET",
                    timeout: 0,
                    headers: {
                        "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                    },
                };

                $.ajax(settings).done(function (response) {
                    let responsedata = response;

                    $('#editdistfield').val(responsedata['user']['id']);

                    responsedata.commandesLines.forEach(function (item) {
                        editselectedProducts.push({
                            id: item.produit.id,
                            designation: item.produit.designation,
                            reference: item.produit.reference,
                            type: item.produit.type.designation,
                            mesure: item.produit.mesure.designation,
                            couleur: item.produit.couleur.designation,
                            prixunitaire: item.prixunitaire,
                            quantity: item.quantite,
                            total: item.prixtotal,
                            img: item.produit.image
                        });


                        $('#editselectedProducts').append(
                            `<div class="relative text-xs grid grid-cols-12 items-center justify-between py-2 rounded-lg editproduct-row mb-3
                            backslate defaultdark px-2 pr-6" id="prodselline_${item.produit.id}" data-product-id="${item.produit.id}">
                            <div class="flex items-center col-span-3">
                                <img src="${item.produit.image}" alt="Avatar" class="h-12 w-12 rounded-lg mr-4">
                                <div>
                                    <h3 class="text-md font-bold text-blue-600 editnameprod">${item.produit.designation}</h3>
                                    <p class="text-gray-800 editrefprod">${item.produit.reference}</p>
                                </div>
                            </div>
                            <div class="col-span-3 grid grid-cols-3 gap-x-2">
                                <div class="col-span-3 edittypeprod">${item.produit.type.designation}</div>
                                <div class="col-span-1 editmesureprod">${item.produit.mesure.designation}</div>
                                <div class="col-span-2 editcolorprod">${item.produit.couleur.designation}</div>
                            </div>
                            <div class="col-span-2 grid grid-cols-6 gap-x-2 pl-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editpriceprod text-right pr-4 font-bold" data-value="${item.prixunitaire}">
                                    ${item.prixunitaire} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editpriceprodttc font-bold" data-value="${item.prixunitaire * 0.19 + item.prixunitaire}">
                                    ${item.prixunitaire * 0.19 + item.prixunitaire} DA
                                </div>
                            </div>

                            <div class="col-span-2 pr-2">
                                <input type="number" class="editproduct-quantity bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg
                                focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="${item.quantite}" min="0" />
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editproduct-total text-right pr-4 font-bold">
                                    ${formatNumber(item.prixtotal)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editproduct-totalttc font-bold">
                                    ${formatNumber(item.prixtotal + item.prixtotal * 0.19)} DA
                                </div>
                            </div>
                            <button class="absolute top-4 right-2 editremoveProduct bg-red-500 text-white p-2 rounded-lg hover:bg-red-400" data-product-id="${item.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`
                        );


                    });

                    editfetchProducts();
                    editrecalculateTotals();

                });


            });

            function editfetchProducts() {
                var settings = {
                    "url": "/api/products?active=true&typeproduit=" + $('#edittypeFilter').val() + "&mesure_id=" + $('#editmeasureFilter').val() + "" +
                        "&couleur_produit=" + $('#editcolorfilter').val(),
                    "method": "GET",
                    "timeout": 0,
                    "headers": {
                        "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                    },
                };

                $.ajax(settings).done(function (response) {
                    $('#editproductList').empty();

                    response.forEach(function (product) {
                        var prix_publiqueformat = formatNumber(product.prix_publique);
                        var productId = product.produit_id;


                        var selectedProduct = editselectedProducts.find(p => p.id === productId);
                        var quantity = selectedProduct ? selectedProduct.quantity : 0;
                        var isSelected = quantity > 0;
                        var prixttc = product.prix_publique + product.prix_publique * 0.19;

                        var productHtml = `
                        <div class="text-xs grid grid-cols-12 items-center justify-between ${isSelected ? 'backslate defaultdark' : 'backslateslite text-slate'} p-2
                            rounded-lg editproduct-row" data-price="${product.prix_publique}" data-product-id="${productId}">
                            <div class="flex items-center col-span-3">
                                <img src="/media/${product.image || 'default_image.png'}" alt="Avatar" class="h-12 w-12 rounded-lg mr-4 editimageprod">
                                <div>
                                    <h3 class="text-md font-bold text-blue-600 editnameprod">${product.designation}</h3>
                                    <p class="text-gray-800 editrefprod">${product.reference}</p>
                                </div>
                            </div>

                            <div class="col-span-3 grid grid-cols-3 gap-x-2">
                                <div class="col-span-3 edittypeprod">${product.typeproduit_designation}</div>
                                <div class="col-span-1 editmesureprod">${product.mesure_designation}</div>
                                <div class="col-span-2 editcolorprod">${product.couleur}</div>
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2 pl-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editpriceprod text-right pr-4 font-bold" data-value="${product.prix_publique}">
                                    ${prix_publiqueformat} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editpriceprodttc font-bold" data-value="${product.prix_publique}">
                                    ${formatNumber(prixttc)} DA
                                </div>
                            </div>

                            <div class="col-span-2 pr-2">
                                <input type="number" class="editnumbprod editproduct-quantity bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="${quantity}" min="0" />
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editproduct-total text-right pr-4 font-bold">
                                    ${formatNumber(quantity * product.prix_publique)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editproduct-totalttc font-bold">
                                    ${formatNumber(quantity * product.prix_publique + (quantity * product.prix_publique * 0.19))} DA
                                </div>
                            </div>
                        </div>
                    `;

                        $('#editproductList').append(productHtml);


                    });
                });
            }


            // Fetch products initially
            editfetchProducts();

            // Attach event listeners to filter fields
            $('#edittypeFilter, #editmeasureFilter, #editcolorfilter').on('change', function () {
                editfetchProducts();
            });

            // Example code for handling input change (for completeness)
            $(document).on('input', '.editproduct-quantity', function () {
                var productRow = $(this).closest('.editproduct-row');
                var quantity = parseInt($(this).val()) || 0;  // Ensure valid integer
                var productId = productRow.data('product-id');
                var prixunitaire = parseFloat(productRow.find('.editpriceprod').data('value'));
                var total = prixunitaire * quantity;
                var totalttc = total + total * 0.19;

                // Update the product total in the first slider
                if (quantity >= 1) {
                    productRow.find('.editproduct-total').text(`${formatNumber(total)} DA`);
                    productRow.find('.editproduct-totalttc').text(`${formatNumber(totalttc)} DA`);

                    productRow.removeClass("backslateslite");
                    productRow.removeClass("text-slate");
                    productRow.addClass("backslate");
                    productRow.addClass("defaultdark");

                    // Add or update in selectedProducts list
                    var existingProduct = editselectedProducts.find(p => p.id === productId);

                    if (existingProduct) {
                        existingProduct.quantity = quantity;
                        existingProduct.total = total;

                        // Update the second slider if the product is already added

                        //var secondSliderRow = $('#editselectedProducts .editproduct-row[data-product-id="' + productId + '"]').first();
                        secondSliderRow = $('#prodselline_' + productId);


                        secondSliderRow.find('.editproduct-quantity').val(quantity);
                        secondSliderRow.find('.editproduct-total').text(`${formatNumber(total)} DA`);
                        secondSliderRow.find('.editproduct-totalttc').text(`${formatNumber(totalttc)} DA`);
                    } else {
                        editselectedProducts.push({
                            id: productId,
                            designation: productRow.find('.nameprod').text(),
                            reference: productRow.find('.refprod').text(),
                            type: productRow.find('.typeprod').html(),
                            mesure: productRow.find('.mesureprod').html(),
                            couleur: productRow.find('.colorprod').html(),
                            prixunitaire: prixunitaire,
                            quantity: quantity,
                            total: total,
                            img: productRow.find('img').attr('src')
                        });

                        // Add the product to the second slider
                        $('#editselectedProducts').append(
                            `<div class="relative text-xs grid grid-cols-12 items-center justify-between py-2 rounded-lg editproduct-row mb-3
                            backslate defaultdark px-2 pr-6" data-product-id="${productId}">
                            <div class="flex items-center col-span-3">
                                <img src="${productRow.find('.imageprod').attr('src')}" alt="Avatar" class="h-12 w-12 rounded-lg mr-4">
                                <div>
                                    <h3 class="text-md font-bold text-blue-600 editnameprod">${productRow.find('.nameprod').text()}</h3>
                                    <p class="text-gray-800 editrefprod">${productRow.find('.refprod').text()}</p>
                                </div>
                            </div>
                            <div class="col-span-3 grid grid-cols-3 gap-x-2">
                                <div class="col-span-3 edittypeprod">${productRow.find('.typeprod').text()}</div>
                                <div class="col-span-1 editmesureprod">${productRow.find('.mesureprod').text()}</div>
                                <div class="col-span-2 editcolorprod">${productRow.find('.colorprod').text()}</div>
                            </div>
                            <div class="col-span-2 grid grid-cols-6 gap-x-2 pl-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editpriceprod text-right pr-4 font-bold" data-value="${prixunitaire}">
                                    ${formatNumber(prixunitaire)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editpriceprodttc font-bold" data-value="${prixunitaire * 0.19 + prixunitaire}">
                                    ${prixunitaire * 0.19 + prixunitaire} DA
                                </div>
                            </div>

                            <div class="col-span-2 pr-2">
                                <input type="number" class="editproduct-quantity bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="${quantity}" min="0" />
                            </div>

                            <div class="col-span-2 grid grid-cols-6 gap-x-2">
                                <div class="col-span-1">HT</div>
                                <div class="col-span-5 editproduct-total text-right pr-4 font-bold">
                                    ${formatNumber(total)} DA
                                </div>
                                <div class="col-span-1">TTC</div>
                                <div class="col-span-5 text-right pr-4 editproduct-totalttc font-bold">
                                    ${formatNumber(total + total * 0.19)} DA
                                </div>
                            </div>
                            <button class="absolute top-4 right-2 editremoveProduct bg-red-500 text-white p-2 rounded-lg hover:bg-red-400" data-product-id="${productId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`
                        );
                    }
                } else {
                    productRow.find('.editproduct-total').text('0 DA');
                    productRow.find('.editproduct-totalttc').text('0 DA');

                    productRow.addClass("backslateslite");
                    productRow.addClass("text-slate");
                    productRow.removeClass("backslate");
                    productRow.removeClass("defaultdark");

                    editselectedProducts = editselectedProducts.filter(p => p.id !== productId);

                    $('#editselectedProducts .editproduct-row[data-product-id="' + productId + '"]').remove();
                }

                editrecalculateTotals();
            });

            $(document).on('click', '.editremoveProduct', function () {
                var productId = $(this).data('product-id');
                var productRow = $('#editproductList .editproduct-row[data-product-id="' + productId + '"]');

                // Reset quantity and deselect
                productRow.find('.editproduct-quantity').val('0');
                productRow.removeClass('backslate');
                productRow.removeClass('defaultdark');
                productRow.find('.editproduct-total').text('0 DA');
                productRow.find('.editproduct-totalttc').text('0 DA');

                // Remove from selectedProducts
                editselectedProducts = editselectedProducts.filter(p => p.id !== productId);

                // Remove from second slider
                $(this).closest('.editproduct-row').remove();

                editrecalculateTotals();
            });


            $(document).on('input', '#editselectedProducts .editproduct-quantity', function () {
                var productRow = $(this).closest('.editproduct-row');
                var productId = productRow.data('product-id');
                var quantity = parseInt($(this).val()) || 0;  // Ensure valid integer
                var prixunitaire = parseFloat(productRow.find('.editpriceprod').data('value'));
                var total = prixunitaire * quantity;
                var totalttc = total + total * 0.19;

                // Update the product total in the second slider
                productRow.find('.editproduct-total').text(`${formatNumber(total)} DA`);
                productRow.find('.editproduct-totalttc').text(`${formatNumber(totalttc)} DA`);

                // Find the corresponding product row in the first slider and update its quantity
                var firstSliderRow = $('#editproductList .editproduct-row[data-product-id="' + productId + '"]');
                firstSliderRow.find('.editproduct-quantity').val(quantity);

                // Update total and totals in the first slider
                var firstSliderTotal = firstSliderRow.find('.editpriceprod').data('value') * quantity;
                var firstSliderTotalTTC = firstSliderTotal + (firstSliderTotal * 0.19);

                firstSliderRow.find('.editproduct-total').text(`${formatNumber(firstSliderTotal)} DA`);
                firstSliderRow.find('.editproduct-totalttc').text(`${formatNumber(firstSliderTotalTTC)} DA`);

                // Update the selectedProducts array
                var existingProduct = editselectedProducts.find(p => p.id === productId);
                if (existingProduct) {
                    existingProduct.quantity = quantity;
                    existingProduct.total = total;
                }

                // Recalculate totals for both sliders
                editrecalculateTotals();
            });

            function editrecalculateTotals() {
                let totalPrice = 0;
                editselectedProducts.forEach(function (product) {
                    totalPrice += product.total;
                });

                // Update the total price and tax amounts
                $('#edittotalPrice').text(`${formatNumber(totalPrice)} DA`);
                const taxAmount = totalPrice * 0.19;
                $('#edittotalPriceTTC').text(`${formatNumber(totalPrice + taxAmount)} DA`);
                $('#edittaxAmount').text(`${formatNumber(taxAmount)} DA`);
                $('#editamountDue').text(`${formatNumber(totalPrice + taxAmount)} DA`);

                // Update the totals in step 3
                $('#edittotalPriceStep3').text(`${formatNumber(totalPrice)} DA`);
                const totalTaxStep3 = totalPrice * 0.19;
                $('#edittaxAmountStep3').text(`${formatNumber(totalTaxStep3)} DA`);
                $('#editamountDueStep3').text(`${formatNumber(totalPrice + totalTaxStep3)} DA`);
            }
        });


        $('.popupButton').click(function () {
            identifiant = $(this).data('identifiant');

            $listeblprod = $('#listeblprod');
            $listeblprod.html('');
            let settings = {
                url: `/api/commandedetail/${identifiant}`,
                method: "GET",
                timeout: 0,
                headers: {
                    "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                },
            };
            cpt = 0;
            $.ajax(settings).done(function (response) {
                let responsedata = response;
                let distributeur_id = responsedata['distributeur_id']; // Defined inside this scope

                for (i = 0; i < responsedata['commandesLines'].length; i++) {
                    itemprod = responsedata['commandesLines'][i];
                    nbrrestant = itemprod['quantite'] - itemprod['total_quantite'];
                    $listeblprod.append(`
                <div class="grid grid-cols-8 bg-gray-50 p-2 rounded-lg mb-2 product-line backslateslite"
                    data-unitprice="${itemprod['prixunitaire']}" data-idprodelem="${itemprod['produit']['id']}">
                    <div class="flex items-center col-span-2">
                        <img src="${itemprod['produit']['image']}" alt="product" class="h-12 w-12 rounded-lg mr-4">
                        <div>
                            <h3 class="font-bold text-blue-600 productName">${itemprod['produit']['designation']}</h3>
                            <p class="text-sm productRef">${itemprod['produit']['reference']}</p>
                        </div>
                    </div>
                    <div class="col-span-1">
                        <h3 class="font-bold productName">${itemprod['produit']['type']['designation']}</h3>
                        <p class="text-sm productRef">${itemprod['produit']['mesure']['designation']}</p>
                    </div>
                    <div class="col-span-1">${itemprod['produit']['couleur']['designation']}</div>
                    <div class="col-span-1 prixunitaire">${formatNumber(itemprod['prixunitaire'])} DA</div>
                    <div class="col-span-1 pr-4 nbrrestant">${nbrrestant}</div>
                    <div class="col-span-1 text-right pr-4">
                        <input type="number" data-idelem="${cpt}" class="inputblquantity review-quantity bg-gray-50 border border-gray-300
                            text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block
                            w-full p-2.5" value="0" min="0" max="${nbrrestant}" />
                    </div>
                    <div class="col-span-1 text-right pr-4 totalbl" id="totalbl_${cpt}">0 DA</div>
                </div>
            `);
                    cpt++;
                }

                // Function to calculate the totals
                function calculateTotals() {
                    let totalHT = 0;

                    // Iterate through each product line
                    $('.product-line').each(function () {
                        const quantity = $(this).find('.review-quantity').val();
                        const unitPrice = parseFloat($(this).data('unitprice'));

                        // Calculate the total for the line
                        const totalLine = quantity * unitPrice;

                        // Update the total for the line
                        $(this).find('.totalbl').text(formatNumber(totalLine) + ' DA');

                        // Add to the total HT
                        totalHT += totalLine;
                    });

                    // Update total HT
                    $('#totalhtbl').text(formatNumber(totalHT) + ' DA');

                    // Calculate and update total with tax
                    const totalTaxe = totalHT + totalHT * 0.19;
                    $('#totaltaxebl').text(formatNumber(totalTaxe) + ' DA');
                }

                // Add event listener for quantity input change
                $('.inputblquantity').on('input', function () {
                    calculateTotals();
                });

                // Initial calculation on popup load
                calculateTotals();

                $('#addbl').fadeIn();

                // Chain the second AJAX request here
                var settings2 = {
                    url: `/api/payeur?distributeur=${distributeur_id}&active=true&draft=false`,
                    method: "GET",
                    timeout: 0,
                };

                $.ajax(settings2).done(function (response) {
                    var $payeurBl = $("#payeur_bl");

                    // Empty the select element
                    $payeurBl.empty();

                    // Populate the select element with the response data
                    response.forEach(function (item) {
                        $payeurBl.append(`<option value="${item.id}">${item.designation}</option>`);
                    });
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    console.error("Request failed:", textStatus, errorThrown);
                });
            });
        });


        // Close the popup
        $('#closePopup').click(function () {
            $('#addbl').fadeOut();
        });

        $(window).click(function (event) {
            if ($(event.target).is('#addbl')) {
                $('#addbl').fadeOut();
            }
        });


        $('#editconfirmOrder').on('click', function () {
            listteproducts = [];
            for (i = 0; i < editselectedProducts.length; i++) {
                listteproducts.push({
                    "produit": editselectedProducts[i]['id'],
                    "quantite": parseInt(editselectedProducts[i]['quantity'])
                })
            }

            var settings = {
                "url": "/api/commande/" + identifiant + '/',
                "method": "put",
                "timeout": 0,
                "headers": {
                    "Content-Type": "application/json",
                    "X-CSRFToken": $('input[name= csrfmiddlewaretoken]').val(),  // Assuming you have CSRF token in your template context
                },
                "data": JSON.stringify({
                    "id": identifiant,
                    "user": $('#distfield').val(),
                    "etat": "Reception",
                    "total": 0,
                    "commandesLines": listteproducts
                }),
            };

            $.ajax(settings)
                .done(function (response) {
                    console.log(response);
                    window.location.href = "/commande/";
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Log the entire jqXHR object to see all details
                    console.log('jqXHR:', jqXHR);

                    // Log the status text
                    console.log('Status:', textStatus);

                    // Log the error thrown
                    console.log('Error Thrown:', errorThrown);

                    // Log the response text, which might contain detailed error messages
                    console.log('Response Text:', jqXHR.responseText);
                    alert(jqXHR.responseText)

                    // Optionally, parse the responseText as JSON if it's in JSON format
                    try {
                        var responseJSON = JSON.parse(jqXHR.responseText);
                        console.log('Response JSON:', responseJSON);
                    } catch (e) {
                        console.error('Failed to parse response as JSON:', e);
                    }

                });

        });


        $('#validatebl').on('click', function (e) {
            e.preventDefault();
            liste_prodbl = [];
            $('#listeblprod .product-line').each(function (index) {
                var product_idbl = parseInt($(this).data('idprodelem'));
                var quantity = parseInt($(this).find('.inputblquantity').val());
                var nbrrestant = parseInt($(this).find('.nbrrestant').html());

                if (quantity > nbrrestant) {
                    alert("Vous ne pouvez pas depasser la quantité réstante.")
                } else {
                    liste_prodbl.push({
                        "produit": product_idbl,
                        "quantite": quantity
                    })
                }
            });

            console.log(liste_prodbl)

            let liste_prodbl_json = JSON.stringify(liste_prodbl);

            var form = new FormData();

            var fcFile = $("#file-upload")[0].files[0];
            var blFile = $("#file-upload2")[0].files[0];

            if (fcFile) {
                form.append("fc_file", fcFile);
            }
            if (blFile) {
                form.append("bl_file", blFile);
            }

            $facture_id = $('#facture_id');

            if ($facture_id.val() === "") facture = null;
            else facture = $facture_id.val();

            // Additional data
            form.append("facture", facture);
            form.append("payeur", $('#payeur_bl').val());
            form.append("BonLivraison", liste_prodbl_json);
            form.append("commandes", identifiant);


            var settings = {
                "url": "/api/blivraison/",
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "X-CSRFToken": $('input[name= csrfmiddlewaretoken]').val(),
                },
                "processData": false,
                "contentType": false,
                "data": form,
            };

            $.ajax(settings)
                .done(function (response) {
                    window.location.href = "/commande/";
                    //console.log(response);
                })
                .fail(function (jqXHR, textStatus, errorThrown) {
                    // Log the entire jqXHR object to see all details
                    console.log('jqXHR:', jqXHR);

                    // Log the status text
                    console.log('Status:', textStatus);

                    // Log the error thrown
                    console.log('Error Thrown:', errorThrown);

                    // Log the response text, which might contain detailed error messages
                    console.log('Response Text:', jqXHR.responseText);
                    alert(jqXHR.responseText)

                    // Optionally, parse the responseText as JSON if it's in JSON format
                    try {
                        var responseJSON = JSON.parse(jqXHR.responseText);
                        console.log('Response JSON:', responseJSON);
                    } catch (e) {
                        console.error('Failed to parse response as JSON:', e);
                    }

                });


        });

        let currentDeleteId = null;

        // Open modal when delete button is clicked
        $('.delete-btn').on('click', function () {
            currentDeleteId = $(this).data('identifiant');
            console.log(currentDeleteId);
            $('#deleteModal').removeClass('hidden');
        });

        // Close modal when cancel is clicked
        $('#cancelDelete').on('click', function () {
            $('#deleteModal').addClass('hidden');
            currentDeleteId = null;
        });

        // Confirm delete action
        $('#confirmDelete').on('click', function () {
            if (currentDeleteId) {
                // Perform the delete action, e.g., make an AJAX call or redirect
                console.log('Deleting item with ID:', currentDeleteId);

                var settings = {
                    "url": "/api/commande/" + currentDeleteId + "/",
                    "method": "DELETE",
                    "timeout": 0,
                    "headers": {
                        "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                    },
                };

                $.ajax(settings).done(function (response) {
                    console.log(response);
                    $('#deleteModal').addClass('hidden');
                    window.location.href = '/commande/'
                });


            }
        });


        $('#file-upload').on('change', function () {
            const fileName = $(this).val().split('\\').pop() || 'No fc file';
            $('#file-name').text(fileName);
        });

        $('#file-upload2').on('change', function () {
            const fileName = $(this).val().split('\\').pop() || 'No bl file';
            $('#file-name2').text(fileName);
        });


        $('.viewButton').on('click', function () {
            identifiantview = $(this).data('identifiant');
            etatview = $(this).data('etat');
            annulelink = "";
            buttonslist = ``;

            if (etatview === "Reception") {
                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = `
                    <button data-href="/commande/etatview?commande=${identifiantview}&etat=Traitement" class="callstate h-10 mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">Valider CMD</button>
                    <button data-href="/commande/etatview?commande=${identifiantview}&etat=Annule" class="callstate h-10 mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">Annuler CMD</button>
                `;
                }
            } else if (etatview === "Traitement") {
                //<a data-href="/commande/bl?commandes=${identifiantview}" class="h-10 mt-4 bg-blue-500 text-white px-4 py-2.5 rounded-lg">Voir BL</a>
                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = `
                    <button data-href="/commande/etatview?commande=${identifiantview}&etat=Preparation" class="callstate h-10 mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">Preparation CMD</button>
                `;
                }

            } else if (etatview === "Preparation") {
                //<a data-href="/commande/bl?commandes=${identifiantview}" class="h-10 mt-4 bg-blue-500 text-white px-4 py-2.5 rounded-lg">Voir BL</a>
                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = `
                    <button data-href="/commande/etatview?commande=${identifiantview}&etat=En cours" class="callstate h-10 mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">Lancer Livraison</button>
                `;
                }
            } else if (etatview === "En cours") {
                //<a data-href="/commande/bl?commandes=${identifiantview}" class="h-10 mt-4 bg-blue-500 text-white px-4 py-2.5 rounded-lg">Voir BL</a>
                buttonslist = ``;
                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = buttonslist + `<a href="/commande/bl?commandes=${identifiantview}" class="h-10 mt-4 bg-blue-500 text-white px-4 py-2.5 rounded-lg">Voir BL</a>
                `;
                }

                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = buttonslist + `<button data-href="/commande/etatview?commande=${identifiantview}&etat=Complete" class="callstate h-10 mt-4 bg-blue-500
                    text-white px-4 py-2 rounded-lg">Completer CMD</button>
                `;
                }


            } else {

                if (listeauth.includes('change_dist_bonlivraison')) {
                    buttonslist = `<a href="/commande/bl?commandes=${identifiantview}" class="h-10 mt-4 bg-blue-500 text-white px-4 py-2.5 rounded-lg">Voir BL</a>
                `;
                }
            }

            $containerdatacmd.html('');
            let settings = {
                url: `/api/commandedetail/${identifiantview}`,
                method: "GET",
                timeout: 0,
                headers: {
                    "X-CSRFToken": $('input[name=csrfmiddlewaretoken]').val(),
                },
            };

            $.ajax(settings).done(function (response) {
                let responsedata = response;
                $containerdatacmd.append(`
                <div class="flex defaultval">
                    <div class="w-12 h-12">
                        <img src="/static/images/puma.svg" alt="Image" class="w-12 h-12">
                    </div>
                    <div class="flex-grow flex flex-wrap">
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Nom & prénom:</p>
                            <p>${responsedata['user']['last_name']} ${responsedata['user']['first_name']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Société:</p>
                            <p>${responsedata['user']['designation']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Téléphone:</p>
                            <p>${responsedata['user']['telephone']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold capital">état:</p>
                            <p>${responsedata['etat']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Code:</p>
                            <p>${responsedata['user']['code']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Ville:</p>
                            <p>${responsedata['user']['ville']['designation']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Adresse:</p>
                            <p>${responsedata['user']['adresse']}</p>
                        </div>
                        <div class="w-1/4 p-2 flex items-center space-x-2">
                            <p class="font-bold">Date:</p>
                            <p>${responsedata['date_ajout']}</p>
                        </div>
                    </div>
                </div>
                <div id="listeitemsprod" class="flex-grow listeprodview overflow-y-auto py-4">
                    <p class="font-bold text-lg mb-4">Liste des produits:</p>
                </div>
                <div class="h-14 flex justify-between items-center" id="totalproducts"></div>
            `);
                totalprodlines = 0;
                for (i = 0; i < responsedata['commandesLines'].length; i++) {
                    $listeitemsprod = $("#listeitemsprod");
                    itemprod = responsedata['commandesLines'][i];
                    totalprodlines = totalprodlines + itemprod['total_prixtotal'];
                    $listeitemsprod.append(`<div class="flex items-center justify-between p-2 backslateslite flex-none mb-2 defaultval">
                <div class="flex items-center w-1/5">
                    <img src="${itemprod['produit']['image']}" alt="product" class="h-12 w-12 rounded-lg mr-4">
                    <div>
                        <h3 class="font-bold text-blue-600 productName">${itemprod['produit']['designation']}</h3>
                        <p class="text-sm productRef">${itemprod['produit']['reference']}</p>
                    </div>
                </div>
                <div class="w-3/5 flex">
                    <div class="w-1/5">${itemprod['produit']['type']['designation']}</div>
                    <div class="w-1/5">${itemprod['produit']['mesure']['designation']}</div>
                    <div class="w-1/5">${itemprod['produit']['couleur']['designation']}</div>
                    <div class="w-1/5 text-right pr-4">${formatNumber(itemprod['prixunitaire'])} DA</div>
                    <div class="w-1/5 pr-4">
                        <div class="flex justify-between">
                            <div>Commandé</div>
                            <div>${itemprod['quantite']}</div>
                        </div>
                        <div class="flex justify-between">
                            <div>Livré</div>
                            <div>${itemprod['total_quantite']}</div>
                        </div>
                    </div>
                </div>
                <div class="w-1/5 text-right pr-4">
                    <div class="flex justify-between">
                        <div>Commandé</div>
                        <div>${formatNumber(itemprod['prixtotal'])} DA</div>
                    </div>
                    <div class="flex justify-between">
                        <div>Livré</div>
                        <div>${formatNumber(itemprod['total_prixtotal'])} DA</div>
                    </div>
                </div>
            </div>`)
                }

                $("#totalproducts").append(`
            <div>
                ${buttonslist}
            </div>

            <div class="text-right pr-4 defaultboldval">
                    <div class="w-full flex">
                        <span class="w-48">Total Commandé</span>
                        <span class="w-48">${formatNumber(itemprod['prixtotal'])} DA HT</span>
                        <span class="w-48">${formatNumber(itemprod['prixtotal'] * 0.19 + itemprod['prixtotal'])} DA Taxe</span>
                    </div>
                    <div class="w-full flex">
                        <span class="w-48">Total Livré</span>
                        <span class="w-48">${formatNumber(itemprod['total_prixtotal'])} DA HT</span>
                        <span class="w-48">${formatNumber(totalprodlines * 0.19 + totalprodlines)} DA Taxe</span>
                    </div>
                </div>
            </div>
            `);


                $('.callstate').on('click', function (event) {
                    event.preventDefault();
                    let link = $(this).data('href');
                    $.ajax({
                        url: link,
                        type: 'GET',
                        success: function (result) {
                            location.reload();  // Refresh the page on success
                        }
                    });
                });

                $('#viewSidebar').toggleClass('translate-x-full');
            });


        });


    </script>
{% endblock %}
